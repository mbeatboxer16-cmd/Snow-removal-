<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Èô§Èõ™ÁÆ°ÁêÜ">
    <meta name="theme-color" content="#0a0e27">
    <meta name="description" content="Ê∞ëÈñìÈô§Èõ™‰ΩúÊ•≠„ÅÆÂá∫Êù•È´òÁÆ°ÁêÜ„Ç¢„Éó„É™ - SNOW OPS">
    
    <!-- PWA Icons -->
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'><rect width='512' height='512' fill='%230a0e27'/><text x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' font-size='256' fill='%2300d4ff'>‚ùÑÔ∏è</text></svg>">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>‚ùÑÔ∏è</text></svg>">
    
    <title>Èô§Èõ™Âá∫Êù•È´òÁÆ°ÁêÜ - SNOW OPS</title>
    
    <!-- Manifest inline -->
    <link rel="manifest" href="data:application/manifest+json,{
        'name': 'Èô§Èõ™Âá∫Êù•È´òÁÆ°ÁêÜ SNOW OPS',
        'short_name': 'SNOW OPS',
        'description': 'Ê∞ëÈñìÈô§Èõ™‰ΩúÊ•≠„ÅÆÂá∫Êù•È´òÁÆ°ÁêÜ„Ç¢„Éó„É™',
        'start_url': './',
        'display': 'standalone',
        'background_color': '%230a0e27',
        'theme_color': '%2300d4ff',
        'orientation': 'portrait',
        'icons': [{
            'src': 'data:image/svg+xml,<svg xmlns=%27http://www.w3.org/2000/svg%27 viewBox=%270 0 512 512%27><rect width=%27512%27 height=%27512%27 fill=%27%230a0e27%27/><text x=%2750%25%27 y=%2750%25%27 dominant-baseline=%27middle%27 text-anchor=%27middle%27 font-size=%27256%27 fill=%27%2300d4ff%27>‚ùÑÔ∏è</text></svg>',
            'sizes': '512x512',
            'type': 'image/svg+xml',
            'purpose': 'any maskable'
        }]
    }">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700;900&family=Exo+2:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    <!-- jsPDF for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        :root {
            --primary: #00d4ff;
            --primary-glow: rgba(0, 212, 255, 0.5);
            --secondary: #6366f1;
            --accent: #fbbf24;
            --bg: #0a0e27;
            --surface: #141b3d;
            --surface-light: #1e2749;
            --text: #e2e8f0;
            --text-dark: #94a3b8;
            --success: #10b981;
            --danger: #ef4444;
            --border: rgba(100, 116, 139, 0.3);
            --glow: 0 0 20px var(--primary-glow);
            --glow-strong: 0 0 30px var(--primary-glow), 0 0 60px var(--primary-glow);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
            writing-mode: horizontal-tb !important;
            text-orientation: mixed !important;
        }

        body {
            font-family: 'Exo 2', -apple-system, BlinkMacSystemFont, 'Hiragino Sans', sans-serif;
            background: var(--bg);
            background-image: 
                radial-gradient(ellipse at top, rgba(0, 212, 255, 0.15) 0%, transparent 50%),
                radial-gradient(ellipse at bottom, rgba(99, 102, 241, 0.1) 0%, transparent 50%);
            background-attachment: fixed;
            color: var(--text);
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            padding-bottom: 90px;
            min-height: 100vh;
            min-height: -webkit-fill-available;
            overscroll-behavior: none;
            -webkit-overflow-scrolling: touch;
        }

        html {
            height: -webkit-fill-available;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                repeating-linear-gradient(
                    0deg,
                    transparent,
                    transparent 2px,
                    rgba(0, 212, 255, 0.03) 2px,
                    rgba(0, 212, 255, 0.03) 4px
                );
            pointer-events: none;
            z-index: 1;
            will-change: auto;
        }

        .header {
            background: rgba(10, 14, 39, 0.95);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(0, 212, 255, 0.2);
            box-shadow: 0 8px 32px rgba(0, 212, 255, 0.1);
            color: white;
            padding: 1.5rem 1rem;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-title {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.75rem;
            font-weight: 900;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            background: linear-gradient(135deg, var(--primary) 0%, #fff 50%, var(--primary) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: 0 0 40px var(--primary-glow);
            animation: shimmer 3s infinite;
        }

        @keyframes shimmer {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        .header-title::before {
            content: '‚ùÑÔ∏è';
            font-size: 2rem;
            filter: drop-shadow(0 0 10px var(--primary));
            animation: rotate 8s linear infinite;
        }

        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .header-subtitle {
            font-family: 'Exo 2', sans-serif;
            font-size: 0.875rem;
            opacity: 0.8;
            margin-top: 0.5rem;
            color: var(--primary);
            font-weight: 600;
            letter-spacing: 0.05em;
        }

        .nav-tabs {
            display: flex;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(10, 14, 39, 0.98);
            backdrop-filter: blur(20px);
            border-top: 1px solid rgba(0, 212, 255, 0.3);
            z-index: 100;
            box-shadow: 0 -8px 32px rgba(0, 212, 255, 0.1);
            padding: 0.5rem;
            gap: 0.5rem;
        }

        .nav-tab {
            flex: 1;
            padding: 1rem 0.5rem;
            text-align: center;
            border: 2px solid var(--border);
            background: rgba(30, 39, 73, 0.4);
            color: var(--text-dark);
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
            border-radius: 16px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            position: relative;
            overflow: hidden;
        }

        .nav-tab::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            opacity: 0;
            transition: opacity 0.4s;
        }

        .nav-tab.active {
            color: var(--primary);
            background: rgba(0, 212, 255, 0.1);
            border-color: var(--primary);
            box-shadow: var(--glow), inset 0 0 20px rgba(0, 212, 255, 0.1);
            transform: translateY(-2px);
        }

        .nav-tab.active::before {
            opacity: 0.1;
        }

        .nav-tab:active {
            transform: translateY(0) scale(0.95);
        }

        .nav-icon {
            font-size: 1.75rem;
            filter: drop-shadow(0 0 8px currentColor);
            transition: all 0.3s;
        }

        .nav-tab.active .nav-icon {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .container {
            padding: 1.5rem 1rem;
            max-width: 800px;
            margin: 0 auto;
            position: relative;
            z-index: 2;
        }

        .screen {
            display: none;
            animation: fadeInUp 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .screen.active {
            display: block;
        }

        @keyframes fadeInUp {
            from { 
                opacity: 0; 
                transform: translateY(30px);
            }
            to { 
                opacity: 1; 
                transform: translateY(0);
            }
        }

        .card {
            background: rgba(20, 27, 61, 0.6);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(0, 212, 255, 0.2);
            border-radius: 24px;
            padding: 2rem 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 
                0 8px 32px rgba(0, 0, 0, 0.4),
                inset 0 1px 0 rgba(255, 255, 255, 0.05);
            position: relative;
            overflow: hidden;
            transition: transform 0.2s ease-out;
            will-change: transform;
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(0, 212, 255, 0.1), transparent);
            transition: left 0.8s;
            pointer-events: none;
        }

        .card:active {
            transform: scale(0.99);
        }

        .card-title {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            text-shadow: 0 0 20px var(--primary-glow);
        }

        .card-title::after {
            content: '';
            flex: 1;
            height: 2px;
            background: linear-gradient(to right, var(--primary), transparent);
            box-shadow: 0 0 10px var(--primary-glow);
        }

        .form-group {
            margin-bottom: 1.5rem;
            /* ÂÖ•ÂäõÊ¨Ñ„ÅÆ„Çø„ÉÉ„ÉÅÊìç‰Ωú„ÇíË®±ÂèØ */
            touch-action: auto;
            -webkit-touch-callout: default;
        }

        .form-label {
            display: block;
            font-weight: 600;
            margin-bottom: 0.75rem;
            color: var(--primary);
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            user-select: text;
            -webkit-user-select: text;
        }

        .form-input {
            width: 100%;
            padding: 1rem 1.25rem;
            border: 2px solid rgba(0, 212, 255, 0.3);
            border-radius: 16px;
            font-size: 1rem;
            transition: all 0.3s ease-out;
            background: rgba(30, 39, 73, 0.4);
            color: var(--text);
            font-family: 'Exo 2', sans-serif;
            -webkit-appearance: none;
            appearance: none;
            min-height: 52px;
            /* „Ç≥„Éî„Éº&„Éö„Éº„Çπ„Éà„ÇíË®±ÂèØ */
            user-select: text;
            -webkit-user-select: text;
            -moz-user-select: text;
            -ms-user-select: text;
            /* iOSÈï∑Êäº„Åó„É°„Éã„É•„ÉºÊúâÂäπÂåñ */
            -webkit-touch-callout: default;
            /* „Çø„ÉÉ„ÉÅ„Ç§„Éô„É≥„ÉàË®±ÂèØ */
            touch-action: auto;
            pointer-events: auto;
        }

        .form-input::placeholder {
            color: var(--text-dark);
            user-select: none;
            -webkit-user-select: none;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary);
            background: rgba(30, 39, 73, 0.6);
            box-shadow: var(--glow), inset 0 0 20px rgba(0, 212, 255, 0.05);
        }

        .form-input::selection {
            background: var(--primary);
            color: white;
        }

        .form-input::-moz-selection {
            background: var(--primary);
            color: white;
        }

        select.form-input {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%2300d4ff' stroke-width='2'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 1rem center;
            padding-right: 3rem;
        }
        
        /* „É©„Éô„É´„ÅÆ„ÉÜ„Ç≠„Çπ„ÉàÈÅ∏Êäû„ÇÇË®±ÂèØ */
        .form-label {
            display: block;
            font-weight: 600;
            margin-bottom: 0.75rem;
            color: var(--primary);
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            user-select: text;
            -webkit-user-select: text;
        }

        .btn {
            padding: 1.25rem 2rem;
            border: none;
            border-radius: 16px;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            transition: transform 0.2s ease-out, box-shadow 0.2s ease-out;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            width: 100%;
            margin-top: 0.5rem;
            font-family: 'Exo 2', sans-serif;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            position: relative;
            overflow: hidden;
            user-select: none;
            -webkit-user-select: none;
            -webkit-touch-callout: none;
            will-change: transform;
            min-height: 52px;
        }

        .btn::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            transform: translateX(-100%);
            transition: transform 0.6s;
            pointer-events: none;
        }

        .btn:active {
            transform: scale(0.97);
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            box-shadow: 0 8px 32px rgba(0, 212, 255, 0.3), 0 0 0 1px rgba(0, 212, 255, 0.5);
            border: 2px solid transparent;
        }

        .btn-primary:active {
            box-shadow: 0 4px 16px rgba(0, 212, 255, 0.3);
        }

        .btn-secondary {
            background: rgba(30, 39, 73, 0.6);
            color: var(--primary);
            border: 2px solid var(--primary);
            box-shadow: inset 0 0 20px rgba(0, 212, 255, 0.1);
        }

        .btn-secondary:hover {
            background: rgba(0, 212, 255, 0.1);
            box-shadow: var(--glow);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success) 0%, #059669 100%);
            color: white;
            box-shadow: 0 8px 32px rgba(16, 185, 129, 0.3);
        }

        .btn-success:hover {
            box-shadow: 0 0 30px rgba(16, 185, 129, 0.5);
            transform: translateY(-3px);
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--danger) 0%, #dc2626 100%);
            color: white;
            box-shadow: 0 8px 32px rgba(239, 68, 68, 0.3);
        }

        .btn-danger:hover {
            box-shadow: 0 0 30px rgba(239, 68, 68, 0.5);
            transform: translateY(-3px);
        }

        .btn-small {
            padding: 0.625rem 1.25rem;
            font-size: 0.875rem;
            width: auto;
        }

        .btn-time {
            padding: 1rem;
            font-size: 0.875rem;
            border-radius: 12px;
            font-weight: 600;
            background: rgba(30, 39, 73, 0.6);
            border: 2px solid rgba(0, 212, 255, 0.3);
            color: var(--text);
        }

        .btn-time.active {
            background: linear-gradient(135deg, var(--success) 0%, #059669 100%);
            border-color: var(--success);
            color: white;
            box-shadow: 0 0 20px rgba(16, 185, 129, 0.5);
        }

        .btn-time:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .location-list {
            list-style: none;
        }

        .location-item {
            background: rgba(30, 39, 73, 0.4);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            padding: 1.25rem;
            border-radius: 16px;
            margin-bottom: 1rem;
            border: 2px solid rgba(0, 212, 255, 0.2);
            border-left: 4px solid var(--primary);
            display: flex;
            justify-content: space-between;
            align-items: start;
            transition: transform 0.2s ease-out, box-shadow 0.2s ease-out;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
            will-change: transform;
        }

        .location-item:active {
            transform: scale(0.98);
            box-shadow: var(--glow), 0 4px 16px rgba(0, 0, 0, 0.3);
        }

        .location-info {
            flex: 1;
            user-select: text;
            -webkit-user-select: text;
        }

        .location-name {
            font-weight: 700;
            font-size: 1.125rem;
            color: var(--primary);
            margin-bottom: 0.5rem;
            text-shadow: 0 0 10px var(--primary-glow);
            user-select: text;
            -webkit-user-select: text;
            writing-mode: horizontal-tb;
            text-orientation: mixed;
            word-break: keep-all;
            overflow-wrap: anywhere;
            white-space: normal;
            text-align: left;
        }

        .location-address {
            font-size: 0.875rem;
            color: var(--text-dark);
            margin-bottom: 0.5rem;
            user-select: text;
            -webkit-user-select: text;
        }

        .location-coords {
            font-size: 0.75rem;
            color: var(--text-dark);
            font-family: 'Courier New', monospace;
            background: rgba(0, 212, 255, 0.1);
            padding: 0.25rem 0.5rem;
            border-radius: 6px;
            display: inline-block;
            user-select: text;
            -webkit-user-select: text;
            cursor: text;
        }

        .location-actions {
            display: flex;
            gap: 0.5rem;
        }

        .checkbox-item {
            background: rgba(30, 39, 73, 0.4);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            padding: 1.25rem;
            border-radius: 16px;
            margin-bottom: 1rem;
            border: 2px solid rgba(0, 212, 255, 0.2);
            display: flex;
            align-items: center;
            gap: 1rem;
            cursor: pointer;
            transition: transform 0.2s ease-out, box-shadow 0.2s ease-out;
            user-select: none;
            -webkit-user-select: none;
            will-change: transform;
            min-height: 68px;
        }

        .checkbox-item:active {
            transform: scale(0.98);
        }

        .checkbox-item.selected {
            border-color: var(--primary);
            background: rgba(0, 212, 255, 0.1);
            box-shadow: var(--glow);
        }

        .checkbox-item input[type="checkbox"] {
            width: 28px;
            height: 28px;
            cursor: pointer;
            accent-color: var(--primary);
            flex-shrink: 0;
        }

        .work-item {
            background: rgba(30, 39, 73, 0.4);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            padding: 1.5rem;
            border-radius: 20px;
            margin-bottom: 1.5rem;
            border: 2px solid rgba(0, 212, 255, 0.2);
            border-left: 5px solid var(--secondary);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
            transition: transform 0.2s ease-out, box-shadow 0.2s ease-out;
            will-change: transform;
        }

        .work-item:active {
            transform: scale(0.99);
        }

        .work-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0;
            gap: 1rem;
            flex-wrap: nowrap;
        }

        .work-order {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            min-width: 44px;
            height: 44px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 900;
            font-size: 1.25rem;
            font-family: 'Orbitron', sans-serif;
            box-shadow: 0 0 20px var(--primary-glow);
            border: 2px solid rgba(255, 255, 255, 0.2);
        }

        .work-name {
            flex: 1;
            padding: 0 1rem;
            font-weight: 700;
            font-size: 1.25rem;
            color: var(--text);
            line-height: 1.3;
            writing-mode: horizontal-tb !important;
            text-orientation: mixed !important;
            word-break: keep-all;
            overflow-wrap: anywhere;
            white-space: normal;
            text-align: left;
            min-width: 0;
            display: block !important;
        }

        .work-location-name {
            font-size: 1.5rem;
            font-weight: 900;
            color: var(--primary);
            text-shadow: 0 0 15px var(--primary-glow);
            margin-top: 0.75rem;
            margin-bottom: 1rem;
            padding: 0.75rem 1rem;
            background: linear-gradient(135deg, rgba(0, 212, 255, 0.1) 0%, rgba(99, 102, 241, 0.1) 100%);
            border-radius: 12px;
            border: 2px solid rgba(0, 212, 255, 0.3);
            font-family: 'Exo 2', 'Hiragino Sans', sans-serif;
            letter-spacing: 0.05em;
            writing-mode: horizontal-tb !important;
            text-orientation: mixed !important;
            word-break: keep-all;
            overflow-wrap: anywhere;
            white-space: normal;
            text-align: left;
            display: block !important;
        }

        .work-details {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
            margin-top: 1rem;
        }

        .work-detail {
            background: rgba(20, 27, 61, 0.6);
            backdrop-filter: blur(10px);
            padding: 1rem;
            border-radius: 12px;
            border: 1px solid rgba(0, 212, 255, 0.2);
            transition: all 0.3s;
        }

        .work-detail:hover {
            border-color: var(--primary);
            background: rgba(20, 27, 61, 0.8);
        }

        .work-detail-label {
            font-size: 0.75rem;
            color: var(--text-dark);
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            font-weight: 600;
        }

        .work-detail-value {
            font-size: 1.125rem;
            font-weight: 700;
            color: var(--primary);
            font-family: 'Orbitron', sans-serif;
            text-shadow: 0 0 10px var(--primary-glow);
        }

        .time-input-group {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .time-input-group input {
            flex: 1;
        }

        .distance-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            background: linear-gradient(135deg, var(--accent) 0%, #f59e0b 100%);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 700;
            font-family: 'Orbitron', sans-serif;
            box-shadow: 0 0 20px rgba(251, 191, 36, 0.5);
            border: 2px solid rgba(255, 255, 255, 0.2);
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .summary-card {
            background: linear-gradient(135deg, rgba(0, 212, 255, 0.2) 0%, rgba(99, 102, 241, 0.2) 100%);
            backdrop-filter: blur(10px);
            border: 2px solid rgba(0, 212, 255, 0.3);
            color: white;
            padding: 1.5rem;
            border-radius: 20px;
            text-align: center;
            box-shadow: 0 8px 24px rgba(0, 212, 255, 0.2);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .summary-card:hover {
            box-shadow: var(--glow-strong);
            transform: translateY(-5px) scale(1.03);
        }

        .summary-label {
            font-size: 0.75rem;
            opacity: 0.9;
            margin-bottom: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            font-weight: 600;
        }

        .summary-value {
            font-size: 2.5rem;
            font-weight: 900;
            font-family: 'Orbitron', sans-serif;
            text-shadow: 0 0 30px var(--primary-glow);
            line-height: 1;
        }

        .summary-unit {
            font-size: 1rem;
            opacity: 0.9;
            margin-left: 0.25rem;
            font-weight: 600;
        }

        .report-tabs {
            display: flex;
            gap: 0.75rem;
            margin-bottom: 1.5rem;
        }

        .report-tab {
            flex: 1;
            padding: 1rem;
            border: 2px solid rgba(0, 212, 255, 0.3);
            background: rgba(30, 39, 73, 0.4);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            cursor: pointer;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            color: var(--text-dark);
        }

        .report-tab:hover {
            border-color: var(--primary);
        }

        .report-tab.active {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            border-color: var(--primary);
            box-shadow: var(--glow);
        }

        .report-table {
            width: 100%;
            border-collapse: collapse;
            background: rgba(20, 27, 61, 0.6);
            backdrop-filter: blur(20px);
            border-radius: 16px;
            overflow: hidden;
            border: 1px solid rgba(0, 212, 255, 0.2);
        }

        .report-table th {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            padding: 1.25rem;
            text-align: left;
            font-weight: 700;
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .report-table td {
            padding: 1.25rem;
            border-bottom: 1px solid rgba(0, 212, 255, 0.1);
            font-size: 0.875rem;
            color: var(--text);
        }

        .report-table tr:last-child td {
            border-bottom: none;
        }

        .report-table tr:hover {
            background: rgba(0, 212, 255, 0.05);
        }

        .empty-state {
            text-align: center;
            padding: 4rem 1rem;
            color: var(--text-dark);
        }

        .empty-icon {
            font-size: 5rem;
            margin-bottom: 1.5rem;
            opacity: 0.3;
            filter: drop-shadow(0 0 20px var(--primary-glow));
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            animation: fadeIn 0.3s;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: rgba(20, 27, 61, 0.95);
            backdrop-filter: blur(30px);
            -webkit-backdrop-filter: blur(30px);
            border: 2px solid rgba(0, 212, 255, 0.3);
            border-radius: 24px;
            padding: 2rem 1.5rem;
            max-width: 500px;
            width: 100%;
            max-height: 85vh;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5), var(--glow);
            animation: slideUp 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            margin: auto;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.5rem;
            font-weight: 900;
            margin-bottom: 1.5rem;
            color: var(--primary);
            text-transform: uppercase;
            letter-spacing: 0.1em;
            text-shadow: 0 0 20px var(--primary-glow);
            text-align: center;
        }

        .order-controls {
            display: flex;
            gap: 0.5rem;
        }

        .order-btn {
            background: rgba(30, 39, 73, 0.6);
            border: 2px solid rgba(0, 212, 255, 0.3);
            border-radius: 10px;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-weight: 700;
            font-size: 1.125rem;
            color: var(--primary);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .order-btn:hover:not(:disabled) {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
            box-shadow: var(--glow);
            transform: scale(1.1);
        }

        .order-btn:disabled {
            opacity: 0.2;
            cursor: not-allowed;
        }

        @media print {
            .header, .nav-tabs, .btn {
                display: none;
            }
            .container {
                padding: 0;
            }
            .card {
                box-shadow: none;
                page-break-inside: avoid;
            }
        }
        
        /* „Çπ„Éû„ÉõÊúÄÈÅ©Âåñ */
        @media (max-width: 768px) {
            .container {
                padding: 1rem 0.75rem;
            }
            
            .card {
                padding: 1.5rem 1rem;
                border-radius: 20px;
            }
            
            .header-title {
                font-size: 1.5rem;
            }
            
            .summary-grid {
                grid-template-columns: 1fr;
                gap: 0.75rem;
            }
            
            .summary-value {
                font-size: 2rem;
            }
            
            .report-table {
                font-size: 0.8rem;
            }
            
            .report-table th,
            .report-table td {
                padding: 0.75rem 0.5rem;
            }
            
            .work-details {
                grid-template-columns: 1fr;
            }
            
            .nav-tab {
                font-size: 0.7rem;
                padding: 0.75rem 0.25rem;
            }
            
            .nav-icon {
                font-size: 1.5rem;
            }
        }
        
        /* Ê•µÂ∞è„Çπ„Éû„ÉõÂØæÂøú */
        @media (max-width: 375px) {
            .header-title {
                font-size: 1.25rem;
            }
            
            .card-title {
                font-size: 1rem;
            }
            
            .btn {
                padding: 1rem 1.5rem;
                font-size: 0.9rem;
            }
            
            .summary-value {
                font-size: 1.75rem;
            }
        }
        
        /* „É©„É≥„Éâ„Çπ„Ç±„Éº„ÉóÂØæÂøú */
        @media (orientation: landscape) and (max-height: 500px) {
            .header {
                padding: 0.75rem 1rem;
            }
            
            .header-title {
                font-size: 1.25rem;
            }
            
            .nav-tabs {
                padding: 0.25rem;
            }
            
            .nav-tab {
                padding: 0.5rem 0.25rem;
            }
        }
        
        /* „Çª„Éº„Éï„Ç®„É™„Ç¢ÂØæÂøúÔºà„Éé„ÉÉ„ÉÅ‰ªò„Åç„Çπ„Éû„ÉõÔºâ */
        @supports (padding: max(0px)) {
            body {
                padding-left: max(0px, env(safe-area-inset-left));
                padding-right: max(0px, env(safe-area-inset-right));
                padding-bottom: max(90px, env(safe-area-inset-bottom, 90px));
            }
            
            .header {
                padding-top: max(1.5rem, env(safe-area-inset-top, 1.5rem));
            }
            
            .nav-tabs {
                padding-bottom: max(0.5rem, env(safe-area-inset-bottom, 0.5rem));
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-title">
            SNOW OPS
        </div>
        <div class="header-subtitle" id="currentDate"></div>
    </div>

    <div class="container">
        <!-- Â•ëÁ¥ÑÂÖàÁôªÈå≤ÁîªÈù¢ -->
        <div id="screen-register" class="screen active">
            <div class="card">
                <div class="card-title">üìç Êñ∞Ë¶èÂ•ëÁ¥ÑÂÖàÁôªÈå≤</div>
                <form id="locationForm">
                    <div class="form-group">
                        <label class="form-label">Â•ëÁ¥ÑÂÖàÂêç</label>
                        <input type="text" id="locationName" class="form-input" placeholder="‰æãÔºö‚óã‚óãÂïÜÂ∫ó" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">‰ΩèÊâÄ</label>
                        <input type="text" id="locationAddress" class="form-input" placeholder="‰æãÔºö‚óã‚óãÂ∏Ç‚óã‚óãÁî∫1-2-3" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Âçò‰æ°„Çø„Ç§„Éó</label>
                        <select id="priceType" class="form-input" required>
                            <option value="flat">‰∏ÄÂºè</option>
                            <option value="hourly">ÊôÇÈñìÂçò‰æ°</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">üåû ÊòºÈñìÂçò‰æ°ÔºàÂÜÜÔºâ</label>
                        <div style="font-size: 0.75rem; color: var(--text-dark); margin-bottom: 0.5rem;">5:00ÔΩû20:00</div>
                        <input type="number" step="1" id="dayPrice" class="form-input" placeholder="‰æãÔºö10000" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">üåô Â§úÈñìÂçò‰æ°ÔºàÂÜÜÔºâ</label>
                        <div style="font-size: 0.75rem; color: var(--text-dark); margin-bottom: 0.5rem;">20:01ÔΩû4:59</div>
                        <input type="number" step="1" id="nightPrice" class="form-input" placeholder="‰æãÔºö15000" required>
                    </div>
                    <button type="submit" class="btn btn-primary">
                        ‚úÖ ÁôªÈå≤„Åô„Çã
                    </button>
                </form>
            </div>

            <div class="card">
                <div class="card-title">üìã ÁôªÈå≤Ê∏à„ÅøÂ•ëÁ¥ÑÂÖà‰∏ÄË¶ß</div>
                <ul id="locationList" class="location-list"></ul>
                
                <div style="margin-top: 1.5rem; padding: 1rem; background: rgba(99, 102, 241, 0.1); border-radius: 12px; border: 1px solid rgba(99, 102, 241, 0.3);">
                    <div style="font-size: 0.875rem; color: var(--text-dark); line-height: 1.6;">
                        <div style="font-weight: 700; color: var(--primary); margin-bottom: 0.5rem;">üíæ „Éá„Éº„ÇøÁÆ°ÁêÜ</div>
                        <div style="margin-bottom: 0.5rem;">‚Ä¢ <strong>„Éá„Éº„ÇøÂá∫Âäõ</strong>ÔºöÂÖ®„Éá„Éº„Çø„Çí„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó</div>
                        <div>‚Ä¢ <strong>„Éá„Éº„ÇøÂèñËæº</strong>Ôºö„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó„Åã„ÇâÂæ©ÂÖÉ„Åæ„Åü„ÅØ‰ªñÁ´ØÊú´„Åã„ÇâÁßªË°å</div>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.75rem; margin-top: 1rem;">
                    <button class="btn btn-secondary" id="exportDataBtn">
                        üì§ „Éá„Éº„ÇøÂá∫Âäõ
                    </button>
                    <button class="btn btn-secondary" id="importDataBtn">
                        üì• „Éá„Éº„ÇøÂèñËæº
                    </button>
                </div>
                <input type="file" id="importFileInput" accept=".json" style="display: none;">
            </div>
        </div>

        <!-- Êú¨Êó•„ÅÆÈô§Èõ™‰ΩúÊ•≠ÁîªÈù¢ -->
        <div id="screen-work" class="screen">
            <div class="card">
                <div class="card-title">üöú Êú¨Êó•„ÅÆÈô§Èõ™‰ΩúÊ•≠</div>
                <button class="btn btn-primary" id="addWorkBtn">
                    ‚ûï ‰ΩúÊ•≠„ÇíËøΩÂä†
                </button>
            </div>

            <div id="workListContainer"></div>

            <div class="card" id="workSummaryCard" style="display: none;">
                <div class="card-title">üìä Êú¨Êó•„ÅÆ‰ΩúÊ•≠„Çµ„Éû„É™„Éº</div>
                <div class="summary-grid">
                    <div class="summary-card">
                        <div class="summary-label">‰ΩúÊ•≠ÁÆáÊâÄ</div>
                        <div class="summary-value" id="summaryLocations">0</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-label">‰ΩúÊ•≠ÊôÇÈñì</div>
                        <div class="summary-value">
                            <span id="summaryWorkTime">0</span>
                            <span class="summary-unit">ÂàÜ</span>
                        </div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-label">‰ºëÊÜ©ÊôÇÈñì</div>
                        <div class="summary-value">
                            <span id="summaryBreakTime">0</span>
                            <span class="summary-unit">ÂàÜ</span>
                        </div>
                    </div>
                </div>
                <div class="summary-grid" style="grid-template-columns: 1fr;">
                    <div class="summary-card" style="background: linear-gradient(135deg, rgba(251, 191, 36, 0.3) 0%, rgba(245, 158, 11, 0.3) 100%); border-color: rgba(251, 191, 36, 0.5);">
                        <div class="summary-label">üí∞ Êú¨Êó•„ÅÆÁ∑èÂ£≤‰∏ä</div>
                        <div class="summary-value" style="color: var(--accent);">
                            <span style="font-size: 1.5rem;">¬•</span>
                            <span id="summaryRevenue">0</span>
                        </div>
                    </div>
                </div>
                <button class="btn btn-success" id="saveWorkBtn">
                    üíæ Êú¨Êó•„ÅÆ‰ΩúÊ•≠„Çí‰øùÂ≠ò
                </button>
                <div id="saveStatus" style="margin-top: 1rem; text-align: center; color: var(--text-dark); font-size: 0.875rem;"></div>
            </div>
        </div>

        <!-- Âá∫Êù•È´òÈõÜË®àÁîªÈù¢ -->
        <div id="screen-report" class="screen">
            <div class="card">
                <div class="card-title">üìà Âá∫Êù•È´òÈõÜË®à</div>
                <div class="report-tabs">
                    <button class="report-tab active" data-period="daily">Êó•Ê¨°</button>
                    <button class="report-tab" data-period="weekly">ÈÄ±Ê¨°</button>
                    <button class="report-tab" data-period="monthly">ÊúàÊ¨°</button>
                </div>
                <div id="reportContent"></div>
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.75rem; margin-top: 1rem;">
                    <button class="btn btn-secondary" id="exportReportBtn">
                        üñ®Ô∏è Âç∞Âà∑
                    </button>
                    <button class="btn btn-secondary" id="exportReportDataBtn">
                        üìÑ PDFÂá∫Âäõ
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- „Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥ -->
    <div class="nav-tabs">
        <button class="nav-tab active" data-screen="register">
            <div class="nav-icon">üìç</div>
            <div>Â•ëÁ¥ÑÂÖà</div>
        </button>
        <button class="nav-tab" data-screen="work">
            <div class="nav-icon">üöú</div>
            <div>‰ΩúÊ•≠</div>
        </button>
        <button class="nav-tab" data-screen="report">
            <div class="nav-icon">üìà</div>
            <div>ÈõÜË®à</div>
        </button>
    </div>

    <!-- Èô§Èõ™ÁÆáÊâÄÈÅ∏Êäû„É¢„Éº„ÉÄ„É´ -->
    <!-- ‰ΩúÊ•≠ËøΩÂä†„É¢„Éº„ÉÄ„É´ -->
    <div id="addWorkModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">‰ΩúÊ•≠ÂÖà„ÇíÈÅ∏Êäû</div>
            <div id="addWorkLocationList" style="max-height: 60vh; overflow-y: auto;"></div>
            <button class="btn btn-secondary" id="cancelAddWorkBtn" style="margin-top: 1rem;">
                „Ç≠„É£„É≥„Çª„É´
            </button>
        </div>
    </div>

    <!-- Á∑®ÈõÜ„É¢„Éº„ÉÄ„É´ -->
    <div id="editModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.8); z-index: 1000; backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); padding: 1rem; overflow-y: auto;">
        <div style="max-width: 600px; margin: 2rem auto; background: var(--surface); border-radius: 24px; padding: 2rem; border: 2px solid rgba(0, 212, 255, 0.3); box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                <h3 style="color: var(--primary); font-family: 'Orbitron', sans-serif; font-size: 1.25rem; margin: 0;">‚úèÔ∏è Â•ëÁ¥ÑÂÖà„ÇíÁ∑®ÈõÜ</h3>
                <button onclick="closeEditModal()" style="background: none; border: none; color: var(--text); font-size: 1.5rem; cursor: pointer; padding: 0.5rem; line-height: 1;">‚úï</button>
            </div>
            
            <form id="editLocationForm">
                <input type="hidden" id="editLocationId">
                <div class="form-group">
                    <label class="form-label">Â•ëÁ¥ÑÂÖàÂêç</label>
                    <input type="text" id="editLocationName" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">‰ΩèÊâÄ</label>
                    <input type="text" id="editLocationAddress" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Âçò‰æ°„Çø„Ç§„Éó</label>
                    <select id="editPriceType" class="form-input" required>
                        <option value="flat">‰∏ÄÂºè</option>
                        <option value="hourly">ÊôÇÈñìÂçò‰æ°</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">üåû ÊòºÈñìÂçò‰æ°ÔºàÂÜÜÔºâ</label>
                    <div style="font-size: 0.75rem; color: var(--text-dark); margin-bottom: 0.5rem;">5:00ÔΩû20:00</div>
                    <input type="number" step="1" id="editDayPrice" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">üåô Â§úÈñìÂçò‰æ°ÔºàÂÜÜÔºâ</label>
                    <div style="font-size: 0.75rem; color: var(--text-dark); margin-bottom: 0.5rem;">20:01ÔΩû4:59</div>
                    <input type="number" step="1" id="editNightPrice" class="form-input" required>
                </div>
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.75rem;">
                    <button type="button" onclick="closeEditModal()" class="btn btn-secondary">„Ç≠„É£„É≥„Çª„É´</button>
                    <button type="submit" class="btn btn-primary">‚úÖ ‰øùÂ≠ò</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // „Éá„Éº„Çø„Çπ„Éà„É¨„Éº„Ç∏
        const Storage = {
            get(key) {
                const data = localStorage.getItem(key);
                return data ? JSON.parse(data) : null;
            },
            set(key, value) {
                localStorage.setItem(key, JSON.stringify(value));
            },
            getArray(key) {
                return this.get(key) || [];
            }
        };

        // Ë∑ùÈõ¢Ë®àÁÆóÔºà„Éí„É•„Éô„Éã„ÅÆÂÖ¨ÂºèÔºâ
        // ÊôÇÈñìÂ∑ÆË®àÁÆóÔºàÂàÜÔºâ
        function calculateTimeDiff(start, end) {
            if (!start || !end) return 0;
            const [sh, sm] = start.split(':').map(Number);
            const [eh, em] = end.split(':').map(Number);
            const startMin = sh * 60 + sm;
            const endMin = eh * 60 + em;
            return endMin - startMin;
        }
        
        // ÊòºÂ§úÂà§ÂÆöÔºàÊôÇÂàª„Åã„ÇâÂà§ÂÆöÔºâ
        // ÊòºÈñì: 5:00„Äú20:00
        // Â§úÈñì: 20:01„Äú4:59
        function isDaytime(timeStr) {
            if (!timeStr) return true; // „Éá„Éï„Ç©„É´„Éà„ÅØÊòºÈñì
            
            const [hours, minutes] = timeStr.split(':').map(Number);
            const totalMinutes = hours * 60 + minutes;
            
            // 5:00 = 300ÂàÜ, 20:00 = 1200ÂàÜ
            const dayStart = 5 * 60;  // 300
            const dayEnd = 20 * 60;   // 1200
            
            // ÊòºÈñì„ÅÆÁØÑÂõ≤ÂÜÖ„Åã„ÉÅ„Çß„ÉÉ„ÇØ
            return totalMinutes >= dayStart && totalMinutes <= dayEnd;
        }
        
        // ÊôÇÂàª„Åã„ÇâÊòºÂ§ú„Ç¢„Ç§„Ç≥„É≥„ÇíÂèñÂæó
        function getTimeIcon(timeStr) {
            return isDaytime(timeStr) ? 'üåû' : 'üåô';
        }
        
        // ÊôÇÂàª„Åã„ÇâÊòºÂ§ú„ÉÜ„Ç≠„Çπ„Éà„ÇíÂèñÂæó
        function getTimeText(timeStr) {
            return isDaytime(timeStr) ? 'ÊòºÈñì' : 'Â§úÈñì';
        }
        
        // ÊôÇÂàª„Åã„ÇâÊòºÂ§ú„Ç´„É©„Éº„ÇíÂèñÂæó
        function getTimeColor(timeStr) {
            return isDaytime(timeStr) ? 'var(--accent)' : 'var(--primary)';
        }
        
        // ÊôÇÈñìÂ∏ØÂà§ÂÆöÔºàÊòºÈñì: true, Â§úÈñì: falseÔºâ
        // ÊòºÈñì: 5:00ÔΩû20:00
        // Â§úÈñì: 20:01ÔΩû4:59
        function isDayTime(hour, minute) {
            const timeInMinutes = hour * 60 + minute;
            const dayStart = 5 * 60; // 5:00
            const dayEnd = 20 * 60; // 20:00
            
            return timeInMinutes >= dayStart && timeInMinutes <= dayEnd;
        }
        
        // ‰ΩúÊ•≠ÊôÇÈñì„ÇíÊòºÈñì„Å®Â§úÈñì„Å´ÂàÜÂâ≤Ë®àÁÆóÔºàÂàÜÂçò‰Ωç„ÅßËøî„ÅôÔºâ
        function calculateDayNightTime(startTime, endTime) {
            if (!startTime || !endTime) {
                return { dayMinutes: 0, nightMinutes: 0 };
            }
            
            const [sh, sm] = startTime.split(':').map(Number);
            const [eh, em] = endTime.split(':').map(Number);
            
            let dayMinutes = 0;
            let nightMinutes = 0;
            
            // ÈñãÂßãÊôÇÂàª„Å®ÁµÇ‰∫ÜÊôÇÂàª„ÇíÂàÜÂçò‰Ωç„Å´Â§âÊèõ
            let currentMinutes = sh * 60 + sm;
            const endMinutes = eh * 60 + em;
            
            // 1ÂàÜ„Åî„Å®„Å´ÊôÇÈñìÂ∏Ø„ÇíÂà§ÂÆö
            while (currentMinutes < endMinutes) {
                const currentHour = Math.floor(currentMinutes / 60);
                const currentMinute = currentMinutes % 60;
                
                if (isDayTime(currentHour, currentMinute)) {
                    dayMinutes++;
                } else {
                    nightMinutes++;
                }
                
                currentMinutes++;
            }
            
            return { dayMinutes, nightMinutes };
        }

        // Êó•‰ªò„Éï„Ç©„Éº„Éû„ÉÉ„Éà
        function formatDate(date) {
            const d = new Date(date);
            return `${d.getFullYear()}/${String(d.getMonth() + 1).padStart(2, '0')}/${String(d.getDate()).padStart(2, '0')}`;
        }

        // DOM„ÅåË™≠„ÅøËæº„Åæ„Çå„Åü„ÇâÂÆüË°å
        document.addEventListener('DOMContentLoaded', function() {
        
        // ‰ΩúÊ•≠‰∏≠„Éá„Éº„Çø„ÇíÂæ©ÂÖÉ
        restoreWorkInProgress();
        
        // ÁèæÂú®Êó•ÊôÇË°®Á§∫
        function updateCurrentDate() {
            const now = new Date();
            const options = { year: 'numeric', month: 'long', day: 'numeric', weekday: 'short' };
            const dateElement = document.getElementById('currentDate');
            if (dateElement) {
                dateElement.textContent = now.toLocaleDateString('ja-JP', options);
            }
        }

        // ÁîªÈù¢Âàá„ÇäÊõø„Åà
        document.querySelectorAll('.nav-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                const screenName = tab.dataset.screen;
                
                // „Çø„Éñ„ÅÆÂàá„ÇäÊõø„Åà
                document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                
                // ÁîªÈù¢„ÅÆÂàá„ÇäÊõø„Åà
                document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
                document.getElementById(`screen-${screenName}`).classList.add('active');
                
                // ÈõÜË®àÁîªÈù¢„ÅÆÂ†¥Âêà„ÅØ„É¨„Éù„Éº„ÉàÊõ¥Êñ∞
                if (screenName === 'report') {
                    updateReport('daily');
                }
            });
        });

        // Â•ëÁ¥ÑÂÖàÁôªÈå≤
        document.getElementById('locationForm').addEventListener('submit', (e) => {
            e.preventDefault();
            
            try {
                // „Éê„É™„Éá„Éº„Ç∑„Éß„É≥
                const name = document.getElementById('locationName').value.trim();
                const address = document.getElementById('locationAddress').value.trim();
                const priceType = document.getElementById('priceType').value;
                const dayPrice = parseFloat(document.getElementById('dayPrice').value);
                const nightPrice = parseFloat(document.getElementById('nightPrice').value);
                
                if (!name) {
                    alert('‚ùå Â•ëÁ¥ÑÂÖàÂêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                    return;
                }
                
                if (!address) {
                    alert('‚ùå ‰ΩèÊâÄ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                    return;
                }
                
                if (isNaN(dayPrice) || dayPrice < 0) {
                    alert('‚ùå ÊòºÈñìÂçò‰æ°„Å´Ê≠£„Åó„ÅÑÈáëÈ°ç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                    return;
                }
                
                if (isNaN(nightPrice) || nightPrice < 0) {
                    alert('‚ùå Â§úÈñìÂçò‰æ°„Å´Ê≠£„Åó„ÅÑÈáëÈ°ç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                    return;
                }
                
                const location = {
                    id: Date.now(),
                    name: name,
                    address: address,
                    priceType: priceType,
                    dayPrice: dayPrice,
                    nightPrice: nightPrice
                };
                
                const locations = Storage.getArray('locations');
                locations.push(location);
                Storage.set('locations', locations);
                
                e.target.reset();
                renderLocationList();
                alert('‚úÖ Â•ëÁ¥ÑÂÖà„ÇíÁôªÈå≤„Åó„Åæ„Åó„Åü');
            } catch (error) {
                console.error('Â•ëÁ¥ÑÂÖàÁôªÈå≤„Ç®„É©„Éº:', error);
                alert('‚ùå ÁôªÈå≤„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message);
            }
        });

        // Â•ëÁ¥ÑÂÖà‰∏ÄË¶ßË°®Á§∫
        function renderLocationList() {
            const locations = Storage.getArray('locations');
            const list = document.getElementById('locationList');
            
            if (locations.length === 0) {
                list.innerHTML = '<div class="empty-state"><div class="empty-icon">üìç</div>ÁôªÈå≤„Åï„Çå„ÅüÂ•ëÁ¥ÑÂÖà„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</div>';
                return;
            }
            
            list.innerHTML = locations.map(loc => {
                // Êó¢Â≠ò„Éá„Éº„Çø„Å®„ÅÆ‰∫íÊèõÊÄß„ÅÆ„Åü„ÇÅ„ÄÅÊòºÂ§úÂçò‰æ°„Åå„Å™„ÅÑÂ†¥Âêà„ÅØ„Éá„Éï„Ç©„É´„ÉàÂÄ§„ÇíË®≠ÂÆö
                const dayPrice = loc.dayPrice || loc.priceAmount || 0;
                const nightPrice = loc.nightPrice || loc.priceAmount || 0;
                const priceType = loc.priceType || 'flat';
                const priceTypeLabel = priceType === 'flat' ? '‰∏ÄÂºè' : 'ÊôÇÈñìÂçò‰æ°';
                
                return `
                <li class="location-item">
                    <div class="location-info">
                        <div class="location-name">${loc.name}</div>
                        <div class="location-address">${loc.address}</div>
                        <div style="margin-top: 0.75rem; display: flex; gap: 0.5rem; flex-wrap: wrap; align-items: center;">
                            <div style="display: inline-flex; align-items: center; gap: 0.5rem; background: rgba(99, 102, 241, 0.2); padding: 0.25rem 0.75rem; border-radius: 8px; border: 1px solid rgba(99, 102, 241, 0.4);">
                                <span style="color: var(--primary); font-weight: 700;">üí∞ ${priceTypeLabel}</span>
                            </div>
                            <div style="display: inline-flex; align-items: center; gap: 0.5rem; background: rgba(251, 191, 36, 0.2); padding: 0.25rem 0.75rem; border-radius: 8px; border: 1px solid rgba(251, 191, 36, 0.4);">
                                <span style="color: var(--accent); font-weight: 700;">üåû Êòº</span>
                                <span style="color: var(--text); font-weight: 700; font-family: 'Orbitron', sans-serif;">${dayPrice.toLocaleString()}ÂÜÜ</span>
                            </div>
                            <div style="display: inline-flex; align-items: center; gap: 0.5rem; background: rgba(99, 102, 241, 0.2); padding: 0.25rem 0.75rem; border-radius: 8px; border: 1px solid rgba(99, 102, 241, 0.4);">
                                <span style="color: var(--primary); font-weight: 700;">üåô Â§ú</span>
                                <span style="color: var(--text); font-weight: 700; font-family: 'Orbitron', sans-serif;">${nightPrice.toLocaleString()}ÂÜÜ</span>
                            </div>
                        </div>
                        <button class="btn btn-secondary btn-small" onclick="openGoogleMaps('${loc.address.replace(/'/g, "\\'")}', '${loc.name.replace(/'/g, "\\'")}', event)" style="margin-top: 0.75rem; width: auto;">
                            üó∫Ô∏è „Éû„ÉÉ„Éó„ÅßË¶ã„Çã
                        </button>
                    </div>
                    <div class="location-actions">
                        <button class="btn btn-secondary btn-small" onclick="editLocation(${loc.id})" style="margin-bottom: 0.5rem;">‚úèÔ∏è Á∑®ÈõÜ</button>
                        <button class="btn btn-danger btn-small" onclick="deleteLocation(${loc.id})">üóëÔ∏è ÂâäÈô§</button>
                    </div>
                </li>
            `}).join('');
        }
        
        // Google„Éû„ÉÉ„Éó„ÅßÈñã„Åè
        window.openGoogleMaps = function(address, name, event) {
            if (event) {
                event.stopPropagation();
            }
            const query = encodeURIComponent(address);
            const mapsUrl = `https://www.google.com/maps/search/${query}`;
            window.open(mapsUrl, '_blank');
        };

        // Â•ëÁ¥ÑÂÖàÂâäÈô§
        window.deleteLocation = function(id) {
            if (!confirm('„Åì„ÅÆÂ•ëÁ¥ÑÂÖà„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü')) return;
            
            let locations = Storage.getArray('locations');
            locations = locations.filter(loc => loc.id !== id);
            Storage.set('locations', locations);
            renderLocationList();
        };
        
        // Â•ëÁ¥ÑÂÖàÁ∑®ÈõÜ
        window.editLocation = function(id) {
            const locations = Storage.getArray('locations');
            const location = locations.find(loc => loc.id === id);
            
            if (!location) {
                alert('Â•ëÁ¥ÑÂÖà„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì');
                return;
            }
            
            // Êó¢Â≠ò„Éá„Éº„Çø„Å®„ÅÆ‰∫íÊèõÊÄß
            const dayPrice = location.dayPrice || location.priceAmount || 0;
            const nightPrice = location.nightPrice || location.priceAmount || 0;
            const priceType = location.priceType || 'flat';
            
            // „Éï„Ç©„Éº„É†„Å´ÂÄ§„Çí„Çª„ÉÉ„Éà
            document.getElementById('editLocationId').value = location.id;
            document.getElementById('editLocationName').value = location.name;
            document.getElementById('editLocationAddress').value = location.address;
            document.getElementById('editPriceType').value = priceType;
            document.getElementById('editDayPrice').value = dayPrice;
            document.getElementById('editNightPrice').value = nightPrice;
            
            // „É¢„Éº„ÉÄ„É´„ÇíË°®Á§∫
            document.getElementById('editModal').style.display = 'block';
        };
        
        // Á∑®ÈõÜ„É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
        window.closeEditModal = function() {
            document.getElementById('editModal').style.display = 'none';
        };
        
        // Á∑®ÈõÜ„Éï„Ç©„Éº„É†ÈÄÅ‰ø°
        document.getElementById('editLocationForm').addEventListener('submit', (e) => {
            e.preventDefault();
            
            try {
                const id = parseInt(document.getElementById('editLocationId').value);
                const name = document.getElementById('editLocationName').value.trim();
                const address = document.getElementById('editLocationAddress').value.trim();
                const priceType = document.getElementById('editPriceType').value;
                const dayPrice = parseFloat(document.getElementById('editDayPrice').value);
                const nightPrice = parseFloat(document.getElementById('editNightPrice').value);
                
                // „Éê„É™„Éá„Éº„Ç∑„Éß„É≥
                if (!name) {
                    alert('‚ùå Â•ëÁ¥ÑÂÖàÂêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                    return;
                }
                
                if (!address) {
                    alert('‚ùå ‰ΩèÊâÄ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                    return;
                }
                
                if (isNaN(dayPrice) || dayPrice < 0) {
                    alert('‚ùå ÊòºÈñìÂçò‰æ°„Å´Ê≠£„Åó„ÅÑÈáëÈ°ç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                    return;
                }
                
                if (isNaN(nightPrice) || nightPrice < 0) {
                    alert('‚ùå Â§úÈñìÂçò‰æ°„Å´Ê≠£„Åó„ÅÑÈáëÈ°ç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                    return;
                }
                
                const locations = Storage.getArray('locations');
                const index = locations.findIndex(loc => loc.id === id);
                
                if (index === -1) {
                    alert('‚ùå Â•ëÁ¥ÑÂÖà„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì');
                    return;
                }
                
                // „Éá„Éº„Çø„ÇíÊõ¥Êñ∞
                locations[index] = {
                    ...locations[index],
                    name: name,
                    address: address,
                    priceType: priceType,
                    dayPrice: dayPrice,
                    nightPrice: nightPrice
                };
                
                Storage.set('locations', locations);
                closeEditModal();
                renderLocationList();
                alert('‚úÖ Â•ëÁ¥ÑÂÖà„ÇíÊõ¥Êñ∞„Åó„Åæ„Åó„Åü');
            } catch (error) {
                console.error('Â•ëÁ¥ÑÂÖàÊõ¥Êñ∞„Ç®„É©„Éº:', error);
                alert('‚ùå Êõ¥Êñ∞„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message);
            }
        });
        
        // „Éá„Éº„Çø„Ç®„ÇØ„Çπ„Éù„Éº„Éà
        document.getElementById('exportDataBtn').addEventListener('click', () => {
            try {
                const locations = Storage.getArray('locations');
                const workRecords = Storage.getArray('workRecords');
                
                if (locations.length === 0 && workRecords.length === 0) {
                    alert('‚ö†Ô∏è „Ç®„ÇØ„Çπ„Éù„Éº„Éà„Åô„Çã„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì');
                    return;
                }
                
                const exportData = {
                    version: '1.0',
                    exportDate: new Date().toISOString(),
                    appName: 'SNOW OPS - Èô§Èõ™Âá∫Êù•È´òÁÆ°ÁêÜ',
                    locations: locations,
                    workRecords: workRecords,
                    statistics: {
                        totalLocations: locations.length,
                        totalWorkRecords: workRecords.length,
                        totalWorkDays: workRecords.length,
                        dateRange: workRecords.length > 0 ? {
                            start: workRecords[0].date,
                            end: workRecords[workRecords.length - 1].date
                        } : null
                    }
                };
                
                const dataStr = JSON.stringify(exportData, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);
                
                const link = document.createElement('a');
                link.href = url;
                const dateStr = new Date().toISOString().split('T')[0];
                link.download = `snow-ops-backup-${dateStr}.json`;
                
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                
                alert(
                    '‚úÖ „Éá„Éº„Çø„Çí„Ç®„ÇØ„Çπ„Éù„Éº„Éà„Åó„Åæ„Åó„ÅüÔºÅ\n\n' +
                    `üìç Â•ëÁ¥ÑÂÖà: ${locations.length}‰ª∂\n` +
                    `üìä ‰ΩúÊ•≠Ë®òÈå≤: ${workRecords.length}‰ª∂\n\n` +
                    'üí° „Åì„ÅÆ„Éï„Ç°„Ç§„É´„ÇíÂÆâÂÖ®„Å™Â†¥ÊâÄ„Å´‰øùÂ≠ò„Åó„Å¶„Åè„Å†„Åï„ÅÑ'
                );
            } catch (error) {
                console.error('Export error:', error);
                alert('‚ùå „Ç®„ÇØ„Çπ„Éù„Éº„Éà„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message);
            }
        });
        
        // „Éá„Éº„Çø„Ç§„É≥„Éù„Éº„Éà
        document.getElementById('importDataBtn').addEventListener('click', () => {
            document.getElementById('importFileInput').click();
        });
        
        document.getElementById('importFileInput').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            
            try {
                // „Éï„Ç°„Ç§„É´Âêç„ÉÅ„Çß„ÉÉ„ÇØ
                if (!file.name.endsWith('.json')) {
                    throw new Error('JSON„Éï„Ç°„Ç§„É´„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                }
                
                const text = await file.text();
                let importData;
                
                try {
                    importData = JSON.parse(text);
                } catch (parseError) {
                    throw new Error('JSON„Éï„Ç°„Ç§„É´„ÅÆÂΩ¢Âºè„ÅåÊ≠£„Åó„Åè„ÅÇ„Çä„Åæ„Åõ„Çì');
                }
                
                // „Éá„Éº„ÇøÊ§úË®º
                if (!importData.locations || !Array.isArray(importData.locations)) {
                    throw new Error('Â•ëÁ¥ÑÂÖà„Éá„Éº„Çø„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì');
                }
                
                if (!importData.workRecords || !Array.isArray(importData.workRecords)) {
                    throw new Error('‰ΩúÊ•≠Ë®òÈå≤„Éá„Éº„Çø„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì');
                }
                
                // „Éê„Éº„Ç∏„Éß„É≥„ÉÅ„Çß„ÉÉ„ÇØ
                if (importData.version && importData.version !== '1.0') {
                    console.warn('Áï∞„Å™„Çã„Éê„Éº„Ç∏„Éß„É≥„ÅÆ„Éá„Éº„Çø„Åß„Åô:', importData.version);
                }
                
                // „Ç§„É≥„Éù„Éº„ÉàÂÜÖÂÆπ„ÅÆÁ¢∫Ë™ç
                const confirmMessage = 
                    'üì• „Éá„Éº„ÇøÂèñËæºÁ¢∫Ë™ç\n\n' +
                    `„Éï„Ç°„Ç§„É´: ${file.name}\n` +
                    `„Ç®„ÇØ„Çπ„Éù„Éº„ÉàÊó•ÊôÇ: ${importData.exportDate ? new Date(importData.exportDate).toLocaleString('ja-JP') : '‰∏çÊòé'}\n\n` +
                    `üìç Â•ëÁ¥ÑÂÖà: ${importData.locations.length}‰ª∂\n` +
                    `üìä ‰ΩúÊ•≠Ë®òÈå≤: ${importData.workRecords.length}‰ª∂\n\n` +
                    'ÂèñËæºÊñπÊ≥ï„ÇíÈÅ∏Êäû:\n' +
                    '„ÄêOK„Äë: Êó¢Â≠ò„Éá„Éº„Çø„Å´ËøΩÂä†\n' +
                    '„Äê„Ç≠„É£„É≥„Çª„É´„Äë: Êó¢Â≠ò„Éá„Éº„Çø„Çí‰∏äÊõ∏„Åç';
                
                const choice = confirm(confirmMessage);
                
                if (choice) {
                    // ËøΩÂä†„É¢„Éº„Éâ
                    const existingLocations = Storage.getArray('locations');
                    const existingRecords = Storage.getArray('workRecords');
                    
                    // ID„ÅÆÈáçË§á„ÇíÈÅø„Åë„Çã„Åü„ÇÅ„ÄÅÊñ∞„Åó„ÅÑID„ÇíÂâ≤„ÇäÂΩì„Å¶
                    const maxLocationId = existingLocations.length > 0 
                        ? Math.max(...existingLocations.map(l => l.id))
                        : 0;
                    
                    const idMapping = {};
                    const newLocations = importData.locations.map((loc, index) => {
                        const newId = maxLocationId + index + 1;
                        idMapping[loc.id] = newId;
                        return {
                            ...loc,
                            id: newId
                        };
                    });
                    
                    // ‰ΩúÊ•≠Ë®òÈå≤„ÅÆlocationId„ÇÇÊõ¥Êñ∞
                    const newRecords = importData.workRecords.map(record => ({
                        ...record,
                        locations: record.locations.map(loc => ({
                            ...loc,
                            locationId: idMapping[loc.locationId] || loc.locationId
                        }))
                    }));
                    
                    Storage.set('locations', [...existingLocations, ...newLocations]);
                    Storage.set('workRecords', [...existingRecords, ...newRecords]);
                    
                    alert(
                        '‚úÖ „Éá„Éº„Çø„ÇíËøΩÂä†„Åó„Åæ„Åó„ÅüÔºÅ\n\n' +
                        `üìç Â•ëÁ¥ÑÂÖà: ${newLocations.length}‰ª∂ËøΩÂä†\n` +
                        `üìä ‰ΩúÊ•≠Ë®òÈå≤: ${newRecords.length}‰ª∂ËøΩÂä†\n\n` +
                        `ÂêàË®à:\n` +
                        `Â•ëÁ¥ÑÂÖà: ${existingLocations.length + newLocations.length}‰ª∂\n` +
                        `‰ΩúÊ•≠Ë®òÈå≤: ${existingRecords.length + newRecords.length}‰ª∂`
                    );
                } else {
                    // ‰∏äÊõ∏„Åç„É¢„Éº„Éâ
                    const doubleCheck = confirm(
                        '‚ö†Ô∏è ÈáçË¶Å„Å™Á¢∫Ë™ç\n\n' +
                        'ÁèæÂú®„ÅÆ„Åô„Åπ„Å¶„ÅÆ„Éá„Éº„Çø„ÅåÂâäÈô§„Åï„Çå„ÄÅ\n' +
                        '„Ç§„É≥„Éù„Éº„Éà„Åô„Çã„Éá„Éº„Çø„ÅßÁΩÆ„ÅçÊèõ„Åà„Çâ„Çå„Åæ„Åô„ÄÇ\n\n' +
                        'Êú¨ÂΩì„Å´‰∏äÊõ∏„Åç„Åó„Åæ„Åô„ÅãÔºü'
                    );
                    
                    if (!doubleCheck) {
                        alert('‚ùå „Ç§„É≥„Éù„Éº„Éà„Çí„Ç≠„É£„É≥„Çª„É´„Åó„Åæ„Åó„Åü');
                        e.target.value = '';
                        return;
                    }
                    
                    Storage.set('locations', importData.locations);
                    Storage.set('workRecords', importData.workRecords);
                    
                    alert(
                        '‚úÖ „Éá„Éº„Çø„Çí‰∏äÊõ∏„Åç„Åó„Åæ„Åó„ÅüÔºÅ\n\n' +
                        `üìç Â•ëÁ¥ÑÂÖà: ${importData.locations.length}‰ª∂\n` +
                        `üìä ‰ΩúÊ•≠Ë®òÈå≤: ${importData.workRecords.length}‰ª∂`
                    );
                }
                
                // ÁîªÈù¢„ÇíÊõ¥Êñ∞
                renderLocationList();
                
                // ÈõÜË®àÁîªÈù¢„ÅåË°®Á§∫„Åï„Çå„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÅØÊõ¥Êñ∞
                const activeTab = document.querySelector('.nav-tab.active');
                if (activeTab && activeTab.dataset.screen === 'report') {
                    updateReport('daily');
                }
                
            } catch (error) {
                console.error('Import error:', error);
                alert('‚ùå „Ç§„É≥„Éù„Éº„Éà„Å´Â§±Êïó„Åó„Åæ„Åó„Åü\n\n' + error.message);
            }
            
            // „Éï„Ç°„Ç§„É´ÂÖ•Âäõ„Çí„É™„Çª„ÉÉ„Éà
            e.target.value = '';
        });

        // Èô§Èõ™ÁÆáÊâÄÈÅ∏Êäû„É¢„Éº„ÉÄ„É´
        // ‰ΩúÊ•≠„É™„Çπ„Éà„ÅÆÁÆ°ÁêÜ
        let workItems = [];
        let workItemCounter = 0;
        
        // „Éö„Éº„Ç∏„É≠„Éº„ÉâÊôÇ„Å´‰ΩúÊ•≠‰∏≠„Éá„Éº„Çø„ÇíÂæ©ÂÖÉ
        function restoreWorkInProgress() {
            try {
                const savedWorkItems = Storage.get('workInProgress');
                const savedCounter = Storage.get('workItemCounter');
                
                if (savedWorkItems && Array.isArray(savedWorkItems)) {
                    // ÊôÇÈñì„Éá„Éº„Çø„ÇíÈô§„ÅÑ„Å¶Âü∫Êú¨„Éá„Éº„Çø„ÇíÂæ©ÂÖÉ
                    workItems = savedWorkItems.map(item => ({
                        id: item.id,
                        locationId: item.locationId,
                        location: item.location
                    }));
                    workItemCounter = savedCounter || 0;
                    
                    if (workItems.length > 0) {
                        renderWorkList();
                        document.getElementById('workSummaryCard').style.display = 'block';
                        
                        // ÊôÇÈñì„Éá„Éº„Çø„ÇíÂæ©ÂÖÉ
                        setTimeout(() => {
                            savedWorkItems.forEach(item => {
                                if (item.timeData) {
                                    const workStart = document.querySelector(`.work-start[data-id="${item.id}"]`);
                                    const workEnd = document.querySelector(`.work-end[data-id="${item.id}"]`);
                                    const breakStart = document.querySelector(`.break-start[data-id="${item.id}"]`);
                                    const breakEnd = document.querySelector(`.break-end[data-id="${item.id}"]`);
                                    
                                    if (workStart && item.timeData.workStart) {
                                        workStart.value = item.timeData.workStart;
                                        const display = document.querySelector(`.work-time-display[data-id="${item.id}"]`);
                                        const btn = document.querySelector(`.work-start-btn[data-id="${item.id}"]`);
                                        if (display) display.textContent = item.timeData.workStart + ' ~ ' + (item.timeData.workEnd || '--:--');
                                        if (btn) {
                                            btn.classList.add('active');
                                            btn.disabled = true;
                                            btn.innerHTML = '‚úì ÈñãÂßãÊ∏à';
                                        }
                                    }
                                    
                                    if (workEnd && item.timeData.workEnd) {
                                        workEnd.value = item.timeData.workEnd;
                                        const display = document.querySelector(`.work-time-display[data-id="${item.id}"]`);
                                        const btn = document.querySelector(`.work-end-btn[data-id="${item.id}"]`);
                                        const breakStartBtn = document.querySelector(`.break-start-btn[data-id="${item.id}"]`);
                                        if (display) display.textContent = item.timeData.workStart + ' ~ ' + item.timeData.workEnd;
                                        if (btn) {
                                            btn.classList.add('active');
                                            btn.disabled = true;
                                            btn.innerHTML = '‚úì ÁµÇ‰∫ÜÊ∏à';
                                        }
                                        if (breakStartBtn) breakStartBtn.disabled = false;
                                        calculateWorkDuration(item.id);
                                    }
                                    
                                    if (breakStart && item.timeData.breakStart) {
                                        breakStart.value = item.timeData.breakStart;
                                        const display = document.querySelector(`.break-time-display[data-id="${item.id}"]`);
                                        const btn = document.querySelector(`.break-start-btn[data-id="${item.id}"]`);
                                        if (display) display.textContent = item.timeData.breakStart + ' ~ ' + (item.timeData.breakEnd || '--:--');
                                        if (btn) {
                                            btn.classList.add('active');
                                            btn.disabled = true;
                                            btn.innerHTML = '‚úì ÈñãÂßãÊ∏à';
                                        }
                                    }
                                    
                                    if (breakEnd && item.timeData.breakEnd) {
                                        breakEnd.value = item.timeData.breakEnd;
                                        const display = document.querySelector(`.break-time-display[data-id="${item.id}"]`);
                                        const btn = document.querySelector(`.break-end-btn[data-id="${item.id}"]`);
                                        if (display) display.textContent = item.timeData.breakStart + ' ~ ' + item.timeData.breakEnd;
                                        if (btn) {
                                            btn.classList.add('active');
                                            btn.disabled = true;
                                            btn.innerHTML = '‚úì ÁµÇ‰∫ÜÊ∏à';
                                        }
                                        calculateWorkDuration(item.id);
                                    }
                                }
                            });
                            
                            calculateSummary();
                        }, 100);
                        
                        console.log('‰ΩúÊ•≠‰∏≠„Éá„Éº„Çø„ÇíÂæ©ÂÖÉ„Åó„Åæ„Åó„Åü:', workItems.length, '‰ª∂');
                    }
                }
            } catch (error) {
                console.error('‰ΩúÊ•≠‰∏≠„Éá„Éº„ÇøÂæ©ÂÖÉ„Ç®„É©„Éº:', error);
            }
        }
        
        // ‰ΩúÊ•≠‰∏≠„Éá„Éº„Çø„Çí‰øùÂ≠òÔºàÊôÇÈñì„Éá„Éº„Çø„ÇÇÂê´„ÇÄÔºâ
        function saveWorkInProgress() {
            try {
                // ÂêÑ‰ΩúÊ•≠„ÅÆÊôÇÈñì„Éá„Éº„Çø„ÇíÂê´„ÇÅ„Å¶‰øùÂ≠ò
                const workItemsWithTime = workItems.map(item => {
                    const workStart = document.querySelector(`.work-start[data-id="${item.id}"]`);
                    const workEnd = document.querySelector(`.work-end[data-id="${item.id}"]`);
                    const breakStart = document.querySelector(`.break-start[data-id="${item.id}"]`);
                    const breakEnd = document.querySelector(`.break-end[data-id="${item.id}"]`);
                    
                    return {
                        ...item,
                        timeData: {
                            workStart: workStart?.value || '',
                            workEnd: workEnd?.value || '',
                            breakStart: breakStart?.value || '',
                            breakEnd: breakEnd?.value || ''
                        }
                    };
                });
                
                Storage.set('workInProgress', workItemsWithTime);
                Storage.set('workItemCounter', workItemCounter);
                console.log('‰ΩúÊ•≠‰∏≠„Éá„Éº„Çø„ÇíËá™Âãï‰øùÂ≠ò„Åó„Åæ„Åó„Åü');
            } catch (error) {
                console.error('‰ΩúÊ•≠‰∏≠„Éá„Éº„Çø‰øùÂ≠ò„Ç®„É©„Éº:', error);
            }
        }
        
        // ‰ΩúÊ•≠‰∏≠„Éá„Éº„Çø„Çí„ÇØ„É™„Ç¢
        function clearWorkInProgress() {
            try {
                localStorage.removeItem('workInProgress');
                localStorage.removeItem('workItemCounter');
                console.log('‰ΩúÊ•≠‰∏≠„Éá„Éº„Çø„Çí„ÇØ„É™„Ç¢„Åó„Åæ„Åó„Åü');
            } catch (error) {
                console.error('‰ΩúÊ•≠‰∏≠„Éá„Éº„Çø„ÇØ„É™„Ç¢„Ç®„É©„Éº:', error);
            }
        }

        // ‰ΩúÊ•≠ËøΩÂä†„Éú„Çø„É≥
        document.getElementById('addWorkBtn').addEventListener('click', () => {
            const locations = Storage.getArray('locations');
            
            if (locations.length === 0) {
                alert('Â•ëÁ¥ÑÂÖà„ÇíÂÖà„Å´ÁôªÈå≤„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }
            
            const list = document.getElementById('addWorkLocationList');
            list.innerHTML = locations.map(loc => `
                <div class="checkbox-item" onclick="addWorkLocation(${loc.id})" style="cursor: pointer; padding: 1rem; margin-bottom: 0.75rem; background: rgba(30, 39, 73, 0.4); border: 2px solid rgba(0, 212, 255, 0.3); border-radius: 16px;">
                    <div style="font-weight: 700; color: var(--primary); margin-bottom: 0.25rem;">${loc.name}</div>
                    <div style="font-size: 0.875rem; color: var(--text-dark);">${loc.address}</div>
                    <div style="margin-top: 0.5rem; font-size: 0.875rem;">
                        <span style="color: var(--accent);">üí∞ ${loc.priceType === 'flat' ? '‰∏ÄÂºè' : 'ÊôÇÈñìÂçò‰æ°'}</span>
                        <span style="color: var(--text); font-weight: 700; margin-left: 0.5rem;">${(loc.priceAmount || 0).toLocaleString()}ÂÜÜ</span>
                    </div>
                </div>
            `).join('');
            
            document.getElementById('addWorkModal').classList.add('active');
        });

        // „Ç≠„É£„É≥„Çª„É´„Éú„Çø„É≥
        document.getElementById('cancelAddWorkBtn').addEventListener('click', () => {
            document.getElementById('addWorkModal').classList.remove('active');
        });

        // ‰ΩúÊ•≠„ÇíËøΩÂä†
        window.addWorkLocation = function(locationId) {
            try {
                const locations = Storage.getArray('locations');
                const location = locations.find(l => l.id === locationId);
                
                if (!location) {
                    console.error('Location not found:', locationId);
                    alert('‚ùå Â•ëÁ¥ÑÂÖà„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì');
                    return;
                }
                
                // Êó¢Â≠ò„Éá„Éº„Çø„Å®„ÅÆ‰∫íÊèõÊÄß„ÅÆ„Åü„ÇÅ„ÄÅÊòºÂ§úÂçò‰æ°ÊÉÖÂ†±„Åå„Å™„ÅÑÂ†¥Âêà„ÅØ„Éá„Éï„Ç©„É´„ÉàÂÄ§„ÇíË®≠ÂÆö
                if (!location.dayPrice && !location.nightPrice) {
                    location.dayPrice = location.priceAmount || 0;
                    location.nightPrice = location.priceAmount || 0;
                }
                
                const workId = workItemCounter++;
                workItems.push({
                    id: workId,
                    locationId: location.id,
                    location: location
                });
                
                console.log('‰ΩúÊ•≠„ÇíËøΩÂä†„Åó„Åæ„Åó„Åü:', {
                    id: workId,
                    locationName: location.name,
                    workItemsCount: workItems.length
                });
                
                document.getElementById('addWorkModal').classList.remove('active');
                renderWorkList();
                document.getElementById('workSummaryCard').style.display = 'block';
                
                // Ëá™Âãï‰øùÂ≠ò
                saveWorkInProgress();
            } catch (error) {
                console.error('‰ΩúÊ•≠ËøΩÂä†„Ç®„É©„Éº:', error);
                alert('‚ùå ‰ΩúÊ•≠„ÅÆËøΩÂä†„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message);
            }
        };

        // ‰ΩúÊ•≠„ÇíÂâäÈô§
        window.removeWorkItem = function(workId) {
            if (!confirm('„Åì„ÅÆ‰ΩúÊ•≠„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü')) return;
            
            workItems = workItems.filter(item => item.id !== workId);
            renderWorkList();
            
            if (workItems.length === 0) {
                document.getElementById('workSummaryCard').style.display = 'none';
            }
            
            // Ëá™Âãï‰øùÂ≠ò
            saveWorkInProgress();
        };

        // ‰ΩúÊ•≠„Çí‰∏ä„Å´ÁßªÂãï
        window.moveWorkUp = function(workId) {
            const index = workItems.findIndex(item => item.id === workId);
            if (index > 0) {
                [workItems[index - 1], workItems[index]] = [workItems[index], workItems[index - 1]];
                renderWorkList();
                saveWorkInProgress();
            }
        };

        // ‰ΩúÊ•≠„Çí‰∏ã„Å´ÁßªÂãï
        window.moveWorkDown = function(workId) {
            const index = workItems.findIndex(item => item.id === workId);
            if (index < workItems.length - 1) {
                [workItems[index], workItems[index + 1]] = [workItems[index + 1], workItems[index]];
                renderWorkList();
                saveWorkInProgress();
            }
        };

        // ‰ΩúÊ•≠„É™„Çπ„Éà„Çí„É¨„É≥„ÉÄ„É™„É≥„Ç∞
        // ‰ΩúÊ•≠„É™„Çπ„Éà„Çí„É¨„É≥„ÉÄ„É™„É≥„Ç∞
        function renderWorkList() {
            try {
                const container = document.getElementById('workListContainer');
                
                if (!container) {
                    console.error('Work list container not found');
                    return;
                }
                
                if (workItems.length === 0) {
                    container.innerHTML = '';
                    return;
                }
                
                container.innerHTML = workItems.map((item, index) => {
                    const loc = item.location;
                    if (!loc) {
                        console.warn('Location not found for work item:', item);
                        return '';
                    }
                    
                    return `
                    <div class="card">
                        <div class="work-item">
                            <div class="work-header">
                                <div class="work-order">${index + 1}</div>
                                <div class="order-controls">
                                    <button class="order-btn" onclick="moveWorkUp(${item.id})" ${index === 0 ? 'disabled' : ''} title="‰∏ä„Å´ÁßªÂãï">‚ñ≤</button>
                                    <button class="order-btn" onclick="moveWorkDown(${item.id})" ${index === workItems.length - 1 ? 'disabled' : ''} title="‰∏ã„Å´ÁßªÂãï">‚ñº</button>
                                    <button class="order-btn" onclick="removeWorkItem(${item.id})" style="background: var(--danger); border-color: var(--danger);" title="ÂâäÈô§">‚úï</button>
                                </div>
                            </div>
                            
                            <div class="work-location-name">${loc.name}</div>
                            
                            <div style="margin-top: 0.75rem; padding: 0.75rem; background: rgba(0, 212, 255, 0.1); border-radius: 12px; border: 1px solid rgba(0, 212, 255, 0.3);">
                                <div style="font-size: 0.875rem; color: var(--text-dark);">üìç ${loc.address}</div>
                            </div>
                            
                            <div style="margin-top: 1rem; padding: 0.75rem; background: rgba(251, 191, 36, 0.15); border-radius: 12px; border: 2px solid rgba(251, 191, 36, 0.4);">
                                <div style="margin-bottom: 0.75rem; text-align: center;">
                                    <span style="display: inline-block; background: rgba(99, 102, 241, 0.2); padding: 0.25rem 0.75rem; border-radius: 8px; border: 1px solid rgba(99, 102, 241, 0.4); color: var(--primary); font-weight: 700; font-size: 0.875rem;">üí∞ ${(loc.priceType || 'flat') === 'flat' ? '‰∏ÄÂºè' : 'ÊôÇÈñìÂçò‰æ°'}</span>
                                </div>
                                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.75rem; margin-bottom: 0.75rem;">
                                    <div>
                                        <div style="font-size: 0.75rem; color: var(--accent); text-transform: uppercase; letter-spacing: 0.1em; font-weight: 600;">üåû ÊòºÈñìÂçò‰æ°</div>
                                        <div style="font-size: 1rem; font-weight: 700; color: var(--accent); font-family: 'Orbitron', sans-serif;">${(loc.dayPrice || 0).toLocaleString()}ÂÜÜ</div>
                                    </div>
                                    <div>
                                        <div style="font-size: 0.75rem; color: var(--primary); text-transform: uppercase; letter-spacing: 0.1em; font-weight: 600;">üåô Â§úÈñìÂçò‰æ°</div>
                                        <div style="font-size: 1rem; font-weight: 700; color: var(--primary); font-family: 'Orbitron', sans-serif;">${(loc.nightPrice || 0).toLocaleString()}ÂÜÜ</div>
                                    </div>
                                </div>
                                <div style="border-top: 1px solid rgba(251, 191, 36, 0.3); padding-top: 0.75rem;">
                                    <div style="font-size: 0.75rem; color: var(--accent); text-transform: uppercase; letter-spacing: 0.1em; font-weight: 600; margin-bottom: 0.5rem;">üíµ ‰∫àÂÆöÈáëÈ°ç</div>
                                    <div class="estimated-amount" data-id="${item.id}" style="font-size: 1.25rem; font-weight: 700; color: var(--accent); font-family: 'Orbitron', sans-serif; text-align: center;">-</div>
                                </div>
                            </div>

                            <div style="margin-top: 1rem;">
                                <div class="work-detail-label">üîß ‰ΩúÊ•≠ÊôÇÈñì</div>
                                <div style="display: flex; gap: 0.75rem; margin-bottom: 0.75rem;">
                                    <button class="btn btn-time work-start-btn" data-id="${item.id}" onclick="recordTime(this, 'work-start')" style="flex: 1;">
                                        ‚ñ∂ ÈñãÂßã
                                    </button>
                                    <button class="btn btn-time work-end-btn" data-id="${item.id}" onclick="recordTime(this, 'work-end')" style="flex: 1;" disabled>
                                        ‚ñ† ÁµÇ‰∫Ü
                                    </button>
                                </div>
                                <div class="work-detail-value" style="text-align: center; padding: 0.75rem; background: rgba(20, 27, 61, 0.6); border-radius: 12px; border: 1px solid rgba(0, 212, 255, 0.2);">
                                    <span class="work-time-display" data-id="${item.id}">--:-- ~ --:--</span>
                                </div>
                                <input type="hidden" class="work-start" data-id="${item.id}">
                                <input type="hidden" class="work-end" data-id="${item.id}">
                            </div>

                            <div style="margin-top: 1.5rem;">
                                <div class="work-detail-label">‚òï ‰ºëÊÜ©ÊôÇÈñì</div>
                                <div style="display: flex; gap: 0.75rem; margin-bottom: 0.75rem;">
                                    <button class="btn btn-time break-start-btn" data-id="${item.id}" onclick="recordTime(this, 'break-start')" style="flex: 1;" disabled>
                                        ‚ñ∂ ÈñãÂßã
                                    </button>
                                    <button class="btn btn-time break-end-btn" data-id="${item.id}" onclick="recordTime(this, 'break-end')" style="flex: 1;" disabled>
                                        ‚ñ† ÁµÇ‰∫Ü
                                    </button>
                                </div>
                                <div class="work-detail-value" style="text-align: center; padding: 0.75rem; background: rgba(20, 27, 61, 0.6); border-radius: 12px; border: 1px solid rgba(0, 212, 255, 0.2);">
                                    <span class="break-time-display" data-id="${item.id}">--:-- ~ --:--</span>
                                </div>
                                <input type="hidden" class="break-start" data-id="${item.id}">
                                <input type="hidden" class="break-end" data-id="${item.id}">
                            </div>

                            <div style="margin-top: 1.5rem; padding: 1.25rem; background: linear-gradient(135deg, rgba(0, 212, 255, 0.1), rgba(99, 102, 241, 0.1)); border-radius: 16px; border: 2px solid rgba(0, 212, 255, 0.3); text-align: center;">
                                <div class="work-detail-label">‚è±Ô∏è Ê≠£Âë≥ÊâÄË¶ÅÊôÇÈñì</div>
                                <div class="work-detail-value work-duration" data-id="${item.id}" style="font-size: 1.5rem; margin-top: 0.5rem;">-</div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            // Âçò‰æ°ÊÉÖÂ†±„Çí‰øùÂ≠òÔºà„Ç∞„É≠„Éº„Éê„É´Â§âÊï∞„Å´Ôºâ
            window.currentWorkLocations = workItems.map(item => item.location);
            
            calculateSummary();
            } catch (error) {
                console.error('‰ΩúÊ•≠„É™„Çπ„Éà„É¨„É≥„ÉÄ„É™„É≥„Ç∞„Ç®„É©„Éº:', error);
                const container = document.getElementById('workListContainer');
                if (container) {
                    container.innerHTML = '<div class="empty-state"><div class="empty-icon">‚ùå</div>‰ΩúÊ•≠„É™„Çπ„Éà„ÅÆË°®Á§∫„Å´Â§±Êïó„Åó„Åæ„Åó„Åü</div>';
                }
            }
        }

        // ÊôÇÈñìË®òÈå≤
        window.recordTime = function(btn, type) {
            try {
                const id = btn.dataset.id;
                if (!id) {
                    console.error('No data-id found on button');
                    return;
                }
                
                const now = new Date();
                const timeStr = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
                
                if (type === 'work-start') {
                    const input = document.querySelector(`.work-start[data-id="${id}"]`);
                    const display = document.querySelector(`.work-time-display[data-id="${id}"]`);
                    const endBtn = document.querySelector(`.work-end-btn[data-id="${id}"]`);
                    
                    if (!input || !display || !endBtn) {
                        console.error('Required elements not found for work-start');
                        return;
                    }
                    
                    input.value = timeStr;
                    display.textContent = timeStr + ' ~ --:--';
                    btn.classList.add('active');
                    btn.disabled = true;
                    btn.innerHTML = '‚úì ÈñãÂßãÊ∏à';
                    endBtn.disabled = false;
                } else if (type === 'work-end') {
                    const input = document.querySelector(`.work-end[data-id="${id}"]`);
                    const startInput = document.querySelector(`.work-start[data-id="${id}"]`);
                    const display = document.querySelector(`.work-time-display[data-id="${id}"]`);
                    const breakStartBtn = document.querySelector(`.break-start-btn[data-id="${id}"]`);
                    
                    if (!input || !startInput || !display || !breakStartBtn) {
                        console.error('Required elements not found for work-end');
                        return;
                    }
                    
                    input.value = timeStr;
                    const startTime = startInput.value;
                    display.textContent = startTime + ' ~ ' + timeStr;
                    btn.classList.add('active');
                    btn.disabled = true;
                    btn.innerHTML = '‚úì ÁµÇ‰∫ÜÊ∏à';
                    breakStartBtn.disabled = false;
                    calculateWorkDuration(id);
                } else if (type === 'break-start') {
                    const input = document.querySelector(`.break-start[data-id="${id}"]`);
                    const display = document.querySelector(`.break-time-display[data-id="${id}"]`);
                    const endBtn = document.querySelector(`.break-end-btn[data-id="${id}"]`);
                    
                    if (!input || !display || !endBtn) {
                        console.error('Required elements not found for break-start');
                        return;
                    }
                    
                    input.value = timeStr;
                    display.textContent = timeStr + ' ~ --:--';
                    btn.classList.add('active');
                    btn.disabled = true;
                    btn.innerHTML = '‚úì ÈñãÂßãÊ∏à';
                    endBtn.disabled = false;
                } else if (type === 'break-end') {
                    const input = document.querySelector(`.break-end[data-id="${id}"]`);
                    const startInput = document.querySelector(`.break-start[data-id="${id}"]`);
                    const display = document.querySelector(`.break-time-display[data-id="${id}"]`);
                    
                    if (!input || !startInput || !display) {
                        console.error('Required elements not found for break-end');
                        return;
                    }
                    
                    input.value = timeStr;
                    const startTime = startInput.value;
                    display.textContent = startTime + ' ~ ' + timeStr;
                    btn.classList.add('active');
                    btn.disabled = true;
                    btn.innerHTML = '‚úì ÁµÇ‰∫ÜÊ∏à';
                    calculateWorkDuration(id);
                }
                
                calculateSummary();
                
                // ÊôÇÈñìË®òÈå≤„ÇíËá™Âãï‰øùÂ≠ò
                saveWorkInProgress();
                
                // ÂÖ®‰ΩúÊ•≠„ÅåÂÆå‰∫Ü„Åó„Å¶„ÅÑ„Çã„Åã„ÉÅ„Çß„ÉÉ„ÇØ
                if (type === 'work-end') {
                    checkAllWorkCompleted();
                }
            } catch (error) {
                console.error('ÊôÇÈñìË®òÈå≤„Ç®„É©„Éº:', error);
                alert('‚ùå ÊôÇÈñì„ÅÆË®òÈå≤„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message);
            }
        };
        
        // ÂÖ®‰ΩúÊ•≠ÂÆå‰∫Ü„ÉÅ„Çß„ÉÉ„ÇØ„Å®Ëá™Âãï‰øùÂ≠ò
        function checkAllWorkCompleted() {
            try {
                let allCompleted = true;
                
                for (const item of workItems) {
                    const workEnd = document.querySelector(`.work-end[data-id="${item.id}"]`);
                    if (!workEnd || !workEnd.value) {
                        allCompleted = false;
                        break;
                    }
                }
                
                if (allCompleted && workItems.length > 0) {
                    // 3ÁßíÂæå„Å´Ëá™Âãï‰øùÂ≠ò„ÅÆÁ¢∫Ë™ç„ÉÄ„Ç§„Ç¢„É≠„Ç∞„ÇíË°®Á§∫
                    setTimeout(() => {
                        if (confirm('‚úÖ ÂÖ®„Å¶„ÅÆ‰ΩúÊ•≠„ÅåÂÆå‰∫Ü„Åó„Åæ„Åó„ÅüÔºÅ\n\nÊú¨Êó•„ÅÆ‰ΩúÊ•≠„Çí‰øùÂ≠ò„Åó„Åæ„Åô„ÅãÔºü')) {
                            document.getElementById('saveWorkBtn').click();
                        }
                    }, 1000);
                }
            } catch (error) {
                console.error('ÂÆå‰∫Ü„ÉÅ„Çß„ÉÉ„ÇØ„Ç®„É©„Éº:', error);
            }
        }

        // ‰ΩúÊ•≠ÊôÇÈñìË®àÁÆó
        function calculateWorkDuration(id) {
            try {
                const startInput = document.querySelector(`.work-start[data-id="${id}"]`);
                const endInput = document.querySelector(`.work-end[data-id="${id}"]`);
                const breakStartInput = document.querySelector(`.break-start[data-id="${id}"]`);
                const breakEndInput = document.querySelector(`.break-end[data-id="${id}"]`);
                const durationDiv = document.querySelector(`.work-duration[data-id="${id}"]`);
                const estimatedAmountDiv = document.querySelector(`.estimated-amount[data-id="${id}"]`);
                
                if (!startInput || !endInput || !durationDiv) {
                    console.warn('Required elements not found for work duration calculation');
                    return;
                }
                
                const workTime = calculateTimeDiff(startInput.value, endInput.value);
                const breakTime = calculateTimeDiff(breakStartInput?.value, breakEndInput?.value);
                const netTime = workTime - breakTime;
                
                if (workTime > 0) {
                    // ÊòºÂ§ú„ÅÆÊôÇÈñì„ÇíÂàÜÂâ≤Ë®àÁÆó
                    const dayNightWork = calculateDayNightTime(startInput.value, endInput.value);
                    const dayNightBreak = calculateDayNightTime(breakStartInput?.value || '', breakEndInput?.value || '');
                    
                    const netDayMinutes = dayNightWork.dayMinutes - dayNightBreak.dayMinutes;
                    const netNightMinutes = dayNightWork.nightMinutes - dayNightBreak.nightMinutes;
                    
                    durationDiv.textContent = `${netTime}ÂàÜ (üåû${netDayMinutes}ÂàÜ üåô${netNightMinutes}ÂàÜ)${breakTime > 0 ? ' ‰ºëÊÜ©' + breakTime + 'ÂàÜ' : ''}`;
                    
                    // ÈáëÈ°çË®àÁÆó
                    const workItem = workItems.find(item => item.id === parseInt(id));
                    if (workItem && estimatedAmountDiv) {
                        const location = workItem.location;
                        const priceType = location.priceType || 'flat';
                        const dayPrice = location.dayPrice || 0;
                        const nightPrice = location.nightPrice || 0;
                        
                        let amount = 0;
                        
                        if (priceType === 'flat') {
                            // ‰∏ÄÂºèÔºöÊòºÈñìÊôÇÈñì„ÅåÂ§ö„ÅÑÂ†¥Âêà„ÅØÊòºÈñìÂçò‰æ°„ÄÅÂ§úÈñìÊôÇÈñì„ÅåÂ§ö„ÅÑÂ†¥Âêà„ÅØÂ§úÈñìÂçò‰æ°
                            amount = netDayMinutes >= netNightMinutes ? dayPrice : nightPrice;
                        } else {
                            // ÊôÇÈñìÂçò‰æ°ÔºöÊòºÈñì„ÅÆÈáëÈ°ç + Â§úÈñì„ÅÆÈáëÈ°ç
                            amount = Math.round((netDayMinutes / 60) * dayPrice) + Math.round((netNightMinutes / 60) * nightPrice);
                        }
                        
                        estimatedAmountDiv.textContent = `¬•${amount.toLocaleString()}`;
                    }
                } else {
                    durationDiv.textContent = '-';
                    if (estimatedAmountDiv) {
                        estimatedAmountDiv.textContent = '-';
                    }
                }
                
                calculateSummary();
            } catch (error) {
                console.error('‰ΩúÊ•≠ÊôÇÈñìË®àÁÆó„Ç®„É©„Éº:', error);
            }
        }

        // „Çµ„Éû„É™„ÉºË®àÁÆó
        function calculateSummary() {
            const locations = workItems.length;
            let totalWorkTime = 0;
            let totalBreakTime = 0;
            let totalRevenue = 0;
            
            workItems.forEach((item) => {
                const id = item.id;
                const startInput = document.querySelector(`.work-start[data-id="${id}"]`);
                const endInput = document.querySelector(`.work-end[data-id="${id}"]`);
                const breakStartInput = document.querySelector(`.break-start[data-id="${id}"]`);
                const breakEndInput = document.querySelector(`.break-end[data-id="${id}"]`);
                
                if (!startInput) return;
                
                const workTime = calculateTimeDiff(startInput.value, endInput.value);
                const breakTime = calculateTimeDiff(breakStartInput.value, breakEndInput.value);
                
                totalWorkTime += workTime;
                totalBreakTime += breakTime;
                
                // ÈáëÈ°çË®àÁÆó
                if (workTime > 0) {
                    const location = item.location;
                    const priceType = location.priceType || 'flat';
                    
                    // ÊòºÂ§ú„ÅÆÊôÇÈñì„ÇíÂàÜÂâ≤Ë®àÁÆó
                    const dayNightWork = calculateDayNightTime(startInput.value, endInput.value);
                    const dayNightBreak = calculateDayNightTime(breakStartInput?.value || '', breakEndInput?.value || '');
                    
                    const netDayMinutes = dayNightWork.dayMinutes - dayNightBreak.dayMinutes;
                    const netNightMinutes = dayNightWork.nightMinutes - dayNightBreak.nightMinutes;
                    
                    const dayPrice = location.dayPrice || 0;
                    const nightPrice = location.nightPrice || 0;
                    
                    if (priceType === 'flat') {
                        // ‰∏ÄÂºèÔºöÊòºÈñìÊôÇÈñì„ÅåÂ§ö„ÅÑÂ†¥Âêà„ÅØÊòºÈñìÂçò‰æ°„ÄÅÂ§úÈñìÊôÇÈñì„ÅåÂ§ö„ÅÑÂ†¥Âêà„ÅØÂ§úÈñìÂçò‰æ°
                        totalRevenue += netDayMinutes >= netNightMinutes ? dayPrice : nightPrice;
                    } else {
                        // ÊôÇÈñìÂçò‰æ°ÔºöÊòºÈñì„ÅÆÈáëÈ°ç + Â§úÈñì„ÅÆÈáëÈ°ç
                        totalRevenue += Math.round((netDayMinutes / 60) * dayPrice) + Math.round((netNightMinutes / 60) * nightPrice);
                    }
                }
            });
            
            document.getElementById('summaryLocations').textContent = locations;
            document.getElementById('summaryWorkTime').textContent = totalWorkTime - totalBreakTime;
            document.getElementById('summaryBreakTime').textContent = totalBreakTime;
            document.getElementById('summaryRevenue').textContent = totalRevenue.toLocaleString();
        }

        // ‰ΩúÊ•≠‰øùÂ≠ò
        document.getElementById('saveWorkBtn').addEventListener('click', () => {
            const statusDiv = document.getElementById('saveStatus');
            
            try {
                statusDiv.textContent = '‰øùÂ≠ò‰∏≠...';
                statusDiv.style.color = 'var(--primary)';
                console.log('‰øùÂ≠òÈñãÂßã');
                console.log('workItems:', workItems);
                
                // ‰ΩúÊ•≠„Éá„Éº„Çø„Åå„ÅÇ„Çã„ÅãÁ¢∫Ë™ç
                if (workItems.length === 0) {
                    statusDiv.textContent = '„Ç®„É©„Éº: ‰øùÂ≠ò„Åô„Çã‰ΩúÊ•≠„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì';
                    statusDiv.style.color = 'var(--danger)';
                    alert('‚ùå ‰øùÂ≠ò„Åô„Çã‰ΩúÊ•≠„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì\n\nÂÖà„Å´„Äå‚ûï ‰ΩúÊ•≠„ÇíËøΩÂä†„Äç„Åß‰ΩúÊ•≠„ÇíËøΩÂä†„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                    return;
                }
                
                const workData = {
                    date: new Date().toISOString().split('T')[0],
                    timestamp: Date.now(),
                    locations: []
                };
                
                // workItemsÈÖçÂàó„ÇíÁõ¥Êé•‰ΩøÁî®
                workItems.forEach((item) => {
                    try {
                        const id = item.id;
                        const location = item.location;
                        
                        if (!location) {
                            console.warn(`Location not found for item ${id}`);
                            return;
                        }
                        
                        const startInput = document.querySelector(`.work-start[data-id="${id}"]`);
                        const endInput = document.querySelector(`.work-end[data-id="${id}"]`);
                        const breakStartInput = document.querySelector(`.break-start[data-id="${id}"]`);
                        const breakEndInput = document.querySelector(`.break-end[data-id="${id}"]`);
                        
                        if (!startInput || !endInput) {
                            console.warn(`Input elements not found for item ${id}`);
                            return;
                        }
                        
                        const workTime = calculateTimeDiff(startInput.value, endInput.value);
                        const breakTime = calculateTimeDiff(breakStartInput?.value || '', breakEndInput?.value || '');
                        const netTime = workTime - breakTime;
                        
                        // ÊòºÂ§ú„ÅÆÊôÇÈñì„ÇíÂàÜÂâ≤Ë®àÁÆó
                        const dayNightWork = calculateDayNightTime(startInput.value, endInput.value);
                        const dayNightBreak = calculateDayNightTime(breakStartInput?.value || '', breakEndInput?.value || '');
                        
                        const netDayMinutes = dayNightWork.dayMinutes - dayNightBreak.dayMinutes;
                        const netNightMinutes = dayNightWork.nightMinutes - dayNightBreak.nightMinutes;
                        
                        // ÈáëÈ°çË®àÁÆó
                        const priceType = location.priceType || 'flat';
                        const dayPrice = location.dayPrice || 0;
                        const nightPrice = location.nightPrice || 0;
                        
                        let amount = 0;
                        if (priceType === 'flat') {
                            // ‰∏ÄÂºèÔºöÊòºÈñìÊôÇÈñì„ÅåÂ§ö„ÅÑÂ†¥Âêà„ÅØÊòºÈñìÂçò‰æ°„ÄÅÂ§úÈñìÊôÇÈñì„ÅåÂ§ö„ÅÑÂ†¥Âêà„ÅØÂ§úÈñìÂçò‰æ°
                            amount = netDayMinutes >= netNightMinutes ? dayPrice : nightPrice;
                        } else {
                            // ÊôÇÈñìÂçò‰æ°ÔºöÊòºÈñì„ÅÆÈáëÈ°ç + Â§úÈñì„ÅÆÈáëÈ°ç
                            amount = Math.round((netDayMinutes / 60) * dayPrice) + Math.round((netNightMinutes / 60) * nightPrice);
                        }
                        
                        workData.locations.push({
                            locationId: location.id,
                            name: location.name,
                            workStart: startInput.value || '',
                            workEnd: endInput.value || '',
                            breakStart: breakStartInput?.value || '',
                            breakEnd: breakEndInput?.value || '',
                            priceType: priceType,
                            dayPrice: dayPrice,
                            nightPrice: nightPrice,
                            dayMinutes: netDayMinutes,
                            nightMinutes: netNightMinutes,
                            calculatedAmount: amount,
                            netWorkTime: netTime
                        });
                    } catch (itemError) {
                        console.error(`Error processing item ${item.id}:`, itemError);
                    }
                });
                
                console.log('‰øùÂ≠ò„Éá„Éº„Çø:', workData);
                console.log('‰øùÂ≠ò„Åô„Çã‰ΩúÊ•≠Êï∞:', workData.locations.length);
                
                if (workData.locations.length === 0) {
                    statusDiv.textContent = '„Ç®„É©„Éº: ‰øùÂ≠ò„Åô„Çã‰ΩúÊ•≠„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì';
                    statusDiv.style.color = 'var(--danger)';
                    console.error('‰ΩúÊ•≠„Éá„Éº„Çø„ÅåÁ©∫„Åß„Åô„ÄÇworkItems:', workItems);
                    alert('‚ùå ‰øùÂ≠ò„Åô„Çã‰ΩúÊ•≠„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì\n\n‰ΩúÊ•≠„ÇíËøΩÂä†„Åó„Å¶„Åã„Çâ‰øùÂ≠ò„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                    return;
                }
                
                const workRecords = Storage.getArray('workRecords');
                workRecords.push(workData);
                Storage.set('workRecords', workRecords);
                
                console.log('‰øùÂ≠òÂÆå‰∫Ü');
                statusDiv.textContent = '‚úÖ ‰øùÂ≠òÊàêÂäüÔºÅ';
                statusDiv.style.color = 'var(--success)';
                alert('Êú¨Êó•„ÅÆ‰ΩúÊ•≠„Çí‰øùÂ≠ò„Åó„Åæ„Åó„ÅüÔºÅ');
                
                // ‰ΩúÊ•≠„É™„Çπ„Éà„Å®‰ΩúÊ•≠‰∏≠„Éá„Éº„Çø„Çí„ÇØ„É™„Ç¢
                setTimeout(() => {
                    workItems = [];
                    workItemCounter = 0;
                    document.getElementById('workListContainer').innerHTML = '';
                    document.getElementById('workSummaryCard').style.display = 'none';
                    window.currentWorkLocations = null;
                    statusDiv.textContent = '';
                    
                    // ‰ΩúÊ•≠‰∏≠„Éá„Éº„Çø„Çí„ÇØ„É™„Ç¢
                    clearWorkInProgress();
                }, 1500);
                
            } catch (error) {
                console.error('‰øùÂ≠ò„Ç®„É©„Éº:', error);
                console.error('„Ç®„É©„Éº„Çπ„Çø„ÉÉ„ÇØ:', error.stack);
                console.error('workItems:', workItems);
                statusDiv.textContent = '‚ùå ‰øùÂ≠òÂ§±Êïó: ' + error.message;
                statusDiv.style.color = 'var(--danger)';
                alert('‚ùå ‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü\n\n„Ç®„É©„Éº: ' + error.message + '\n\n„Éñ„É©„Ç¶„Ç∂„ÅÆ„Ç≥„É≥„ÇΩ„Éº„É´„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
            }
        });

        // „É¨„Éù„Éº„ÉàË°®Á§∫
        function updateReport(period) {
            const workRecords = Storage.getArray('workRecords');
            const locations = Storage.getArray('locations');
            const reportContent = document.getElementById('reportContent');
            
            if (workRecords.length === 0) {
                reportContent.innerHTML = '<div class="empty-state"><div class="empty-icon">üìä</div>‰ΩúÊ•≠Ë®òÈå≤„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</div>';
                return;
            }
            
            let filteredRecords = workRecords;
            const now = new Date();
            
            if (period === 'weekly') {
                const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                filteredRecords = workRecords.filter(r => new Date(r.date) >= weekAgo);
            } else if (period === 'monthly') {
                const monthAgo = new Date(now.getFullYear(), now.getMonth() - 1, now.getDate());
                filteredRecords = workRecords.filter(r => new Date(r.date) >= monthAgo);
            }
            
            // Â•ëÁ¥ÑÂÖà„Åî„Å®„ÅÆÈõÜË®à
            const summary = {};
            filteredRecords.forEach(record => {
                record.locations.forEach(loc => {
                    if (!summary[loc.locationId]) {
                        // Â•ëÁ¥ÑÂÖàÊÉÖÂ†±„ÇíÂèñÂæó
                        const locationInfo = locations.find(l => l.id === loc.locationId) || {};
                        
                        summary[loc.locationId] = {
                            name: loc.name,
                            count: 0,
                            totalTime: 0,
                            totalRevenue: 0,
                            priceType: loc.priceType || locationInfo.priceType || 'flat',
                            priceAmount: loc.priceAmount || locationInfo.priceAmount || 0,
                            workDetails: []
                        };
                    }
                    summary[loc.locationId].count++;
                    
                    // Êóß„Éá„Éº„Çø„Å®„ÅÆ‰∫íÊèõÊÄß
                    if (loc.netWorkTime !== undefined) {
                        summary[loc.locationId].totalTime += loc.netWorkTime;
                    } else {
                        const workTime = calculateTimeDiff(loc.workStart, loc.workEnd);
                        const breakTime = calculateTimeDiff(loc.breakStart, loc.breakEnd);
                        summary[loc.locationId].totalTime += (workTime - breakTime);
                    }
                    
                    // ÈáëÈ°çÈõÜË®à
                    if (loc.calculatedAmount !== undefined) {
                        summary[loc.locationId].totalRevenue += loc.calculatedAmount;
                    }
                    
                    // ‰ΩúÊ•≠Ë©≥Á¥∞„Çí‰øùÂ≠ò
                    summary[loc.locationId].workDetails.push({
                        date: record.date,
                        workStart: loc.workStart,
                        workEnd: loc.workEnd,
                        breakStart: loc.breakStart,
                        breakEnd: loc.breakEnd,
                        netWorkTime: loc.netWorkTime,
                        calculatedAmount: loc.calculatedAmount || 0
                    });
                });
            });
            
            const summaryArray = Object.values(summary).map(s => ({
                ...s,
                avgTime: s.totalTime / s.count
            }));
            
            // Á∑èÂ£≤‰∏äË®àÁÆó
            const totalRevenue = summaryArray.reduce((sum, s) => sum + s.totalRevenue, 0);
            const totalWorkTime = summaryArray.reduce((sum, s) => sum + s.totalTime, 0);
            
            reportContent.innerHTML = `
                <div style="margin-bottom: 1.5rem;">
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; margin-bottom: 1rem;">
                        <div style="padding: 1.25rem; background: linear-gradient(135deg, rgba(251, 191, 36, 0.2), rgba(245, 158, 11, 0.2)); border-radius: 16px; border: 2px solid rgba(251, 191, 36, 0.4); text-align: center;">
                            <div style="font-size: 0.75rem; color: var(--accent); text-transform: uppercase; letter-spacing: 0.1em; font-weight: 600; margin-bottom: 0.5rem;">üí∞ ÊúüÈñìÁ∑èÂ£≤‰∏ä</div>
                            <div style="font-size: 2rem; font-weight: 900; color: var(--accent); font-family: 'Orbitron', sans-serif; text-shadow: 0 0 30px rgba(251, 191, 36, 0.5);">
                                ¬•${totalRevenue.toLocaleString()}
                            </div>
                        </div>
                        <div style="padding: 1.25rem; background: linear-gradient(135deg, rgba(0, 212, 255, 0.2), rgba(99, 102, 241, 0.2)); border-radius: 16px; border: 2px solid rgba(0, 212, 255, 0.3); text-align: center;">
                            <div style="font-size: 0.75rem; color: var(--primary); text-transform: uppercase; letter-spacing: 0.1em; font-weight: 600; margin-bottom: 0.5rem;">‚è±Ô∏è Á∑è‰ΩúÊ•≠ÊôÇÈñì</div>
                            <div style="font-size: 2rem; font-weight: 900; color: var(--primary); font-family: 'Orbitron', sans-serif; text-shadow: 0 0 30px rgba(0, 212, 255, 0.5);">
                                ${totalWorkTime}<span style="font-size: 1rem; opacity: 0.9; margin-left: 0.25rem;">ÂàÜ</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Êó•Âà•Ë®òÈå≤‰∏ÄË¶ß -->
                <div style="margin-bottom: 2rem;">
                    <div style="font-weight: 700; font-size: 1.125rem; margin-bottom: 1rem; color: var(--primary); display: flex; align-items: center; gap: 0.5rem;">
                        <span>üìÖ Êó•Âà•‰ΩúÊ•≠Ë®òÈå≤</span>
                        <span style="font-size: 0.875rem; color: var(--text-dark); font-weight: 400;">(${filteredRecords.length}‰ª∂)</span>
                    </div>
                    <div style="display: grid; gap: 0.75rem;">
                        ${filteredRecords.sort((a, b) => new Date(b.date) - new Date(a.date)).map(record => {
                            const recordRevenue = record.locations.reduce((sum, loc) => sum + (loc.calculatedAmount || 0), 0);
                            const recordTime = record.locations.reduce((sum, loc) => sum + (loc.netWorkTime || 0), 0);
                            return `
                            <div style="background: rgba(30, 39, 73, 0.4); backdrop-filter: blur(10px); padding: 1rem; border-radius: 12px; border: 2px solid rgba(0, 212, 255, 0.2); display: flex; justify-content: space-between; align-items: center; gap: 1rem;">
                                <div style="flex: 1;">
                                    <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 0.5rem;">
                                        <div style="font-weight: 700; font-size: 1.125rem; color: var(--text);">üìÖ ${formatDate(record.date)}</div>
                                        <div style="font-size: 0.875rem; color: var(--text-dark);">${record.locations.length}ÁÆáÊâÄ</div>
                                    </div>
                                    <div style="display: flex; gap: 1.5rem; font-size: 0.875rem;">
                                        <div>
                                            <span style="color: var(--text-dark);">‰ΩúÊ•≠ÊôÇÈñì:</span>
                                            <span style="color: var(--primary); font-weight: 700; margin-left: 0.25rem;">${recordTime}ÂàÜ</span>
                                        </div>
                                        <div>
                                            <span style="color: var(--text-dark);">Â£≤‰∏ä:</span>
                                            <span style="color: var(--accent); font-weight: 700; font-family: 'Orbitron', sans-serif; margin-left: 0.25rem;">¬•${recordRevenue.toLocaleString()}</span>
                                        </div>
                                    </div>
                                    <div style="margin-top: 0.5rem; font-size: 0.75rem; color: var(--text-dark);">
                                        ${record.locations.map(loc => loc.name).join(' / ')}
                                    </div>
                                </div>
                                <button onclick="deleteWorkRecord(${record.timestamp})" class="btn btn-danger btn-small" style="white-space: nowrap;">
                                    üóëÔ∏è ÂâäÈô§
                                </button>
                            </div>
                        `}).join('')}
                    </div>
                </div>
                
                <!-- Â•ëÁ¥ÑÂÖàÂà•ÈõÜË®à -->
                <div style="margin-bottom: 1rem;">
                    <div style="font-weight: 700; font-size: 1.125rem; margin-bottom: 1rem; color: var(--primary);">üìä Â•ëÁ¥ÑÂÖàÂà•ÈõÜË®à</div>
                </div>
                
                <div style="overflow-x: auto;">
                    <table class="report-table">
                        <thead>
                            <tr>
                                <th>Â•ëÁ¥ÑÂÖà</th>
                                <th>Âçò‰æ°</th>
                                <th>‰ΩúÊ•≠ÂõûÊï∞</th>
                                <th>Á∑è‰ΩúÊ•≠ÊôÇÈñì</th>
                                <th>Âπ≥ÂùáÊâÄË¶ÅÊôÇÈñì</th>
                                <th>Â£≤‰∏äÈáëÈ°ç</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${summaryArray.map(s => `
                                <tr style="cursor: pointer;" onclick="toggleDetails('details-${s.name.replace(/[^a-zA-Z0-9]/g, '')}')">
                                    <td>
                                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                                            <span style="font-size: 0.75rem;">‚ñ∂</span>
                                            <strong>${s.name}</strong>
                                        </div>
                                    </td>
                                    <td>
                                        <div style="display: flex; flex-direction: column; gap: 0.25rem;">
                                            <span style="color: var(--accent); font-weight: 600;">${s.priceType === 'flat' ? '‰∏ÄÂºè' : 'ÊôÇÈñì'}</span>
                                            <span style="font-family: 'Orbitron', sans-serif; font-weight: 700;">¬•${s.priceAmount.toLocaleString()}</span>
                                        </div>
                                    </td>
                                    <td>${s.count}Âõû</td>
                                    <td>${s.totalTime}ÂàÜ</td>
                                    <td>${Math.round(s.avgTime)}ÂàÜ</td>
                                    <td style="font-weight: 700; color: var(--accent); font-family: 'Orbitron', sans-serif;">¬•${s.totalRevenue.toLocaleString()}</td>
                                </tr>
                                <tr id="details-${s.name.replace(/[^a-zA-Z0-9]/g, '')}" style="display: none;">
                                    <td colspan="6" style="background: rgba(0, 212, 255, 0.05); padding: 1.5rem;">
                                        <div style="font-weight: 700; margin-bottom: 1rem; color: var(--primary);">üìã ‰ΩúÊ•≠Â±•Ê≠¥</div>
                                        <div style="display: grid; gap: 0.75rem;">
                                            ${s.workDetails.map(detail => `
                                                <div style="background: rgba(20, 27, 61, 0.6); padding: 1rem; border-radius: 12px; border: 1px solid rgba(0, 212, 255, 0.2);">
                                                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem;">
                                                        <div>
                                                            <div style="font-size: 0.75rem; color: var(--text-dark); margin-bottom: 0.25rem;">Êó•‰ªò</div>
                                                            <div style="font-weight: 600;">${formatDate(detail.date)}</div>
                                                        </div>
                                                        <div>
                                                            <div style="font-size: 0.75rem; color: var(--text-dark); margin-bottom: 0.25rem;">‰ΩúÊ•≠ÊôÇÈñì</div>
                                                            <div style="font-weight: 600;">${detail.workStart || '--:--'} ~ ${detail.workEnd || '--:--'}</div>
                                                        </div>
                                                        <div>
                                                            <div style="font-size: 0.75rem; color: var(--text-dark); margin-bottom: 0.25rem;">‰ºëÊÜ©ÊôÇÈñì</div>
                                                            <div style="font-weight: 600;">${detail.breakStart || '--:--'} ~ ${detail.breakEnd || '--:--'}</div>
                                                        </div>
                                                        <div>
                                                            <div style="font-size: 0.75rem; color: var(--text-dark); margin-bottom: 0.25rem;">Ê≠£Âë≥ÊôÇÈñì</div>
                                                            <div style="font-weight: 600; color: var(--primary);">${detail.netWorkTime || 0}ÂàÜ</div>
                                                        </div>
                                                        ${detail.dayMinutes !== undefined && detail.nightMinutes !== undefined ? `
                                                        <div>
                                                            <div style="font-size: 0.75rem; color: var(--text-dark); margin-bottom: 0.25rem;">ÊòºÂ§úÂÜÖË®≥</div>
                                                            <div style="font-weight: 600;">
                                                                <span style="color: var(--accent);">üåû${detail.dayMinutes}ÂàÜ</span>
                                                                <span style="margin: 0 0.25rem;">|</span>
                                                                <span style="color: var(--primary);">üåô${detail.nightMinutes}ÂàÜ</span>
                                                            </div>
                                                        </div>
                                                        ` : ''}
                                                        <div>
                                                            <div style="font-size: 0.75rem; color: var(--text-dark); margin-bottom: 0.25rem;">Â£≤‰∏ä</div>
                                                            <div style="font-weight: 700; color: var(--accent); font-family: 'Orbitron', sans-serif;">¬•${detail.calculatedAmount.toLocaleString()}</div>
                                                        </div>
                                                    </div>
                                                </div>
                                            `).join('')}
                                        </div>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }
        
        // Ë©≥Á¥∞Ë°®Á§∫Âàá„ÇäÊõø„Åà
        window.toggleDetails = function(id) {
            const detailRow = document.getElementById(id);
            const isVisible = detailRow.style.display !== 'none';
            detailRow.style.display = isVisible ? 'none' : 'table-row';
            
            // Áü¢Âç∞„ÅÆÂêë„Åç„ÇíÂ§âÊõ¥
            const parentRow = detailRow.previousElementSibling;
            const arrow = parentRow.querySelector('span');
            if (arrow) {
                arrow.textContent = isVisible ? '‚ñ∂' : '‚ñº';
            }
        };
        
        // ‰ΩúÊ•≠Ë®òÈå≤ÂâäÈô§
        window.deleteWorkRecord = function(timestamp) {
            try {
                const workRecords = Storage.getArray('workRecords');
                const record = workRecords.find(r => r.timestamp === timestamp);
                
                if (!record) {
                    alert('‚ùå ÂâäÈô§„Åô„ÇãË®òÈå≤„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì');
                    return;
                }
                
                // ÂâäÈô§Á¢∫Ë™ç
                const recordDate = formatDate(record.date);
                const recordRevenue = record.locations.reduce((sum, loc) => sum + (loc.calculatedAmount || 0), 0);
                const confirmMessage = `„Åì„ÅÆ‰ΩúÊ•≠Ë®òÈå≤„ÇíÂâäÈô§„Åó„Å¶„ÇÇ„Çà„Çç„Åó„ÅÑ„Åß„Åô„ÅãÔºü\n\nÊó•‰ªò: ${recordDate}\n‰ΩúÊ•≠ÁÆáÊâÄ: ${record.locations.length}ÁÆáÊâÄ\nÂ£≤‰∏ä: ¬•${recordRevenue.toLocaleString()}\n\n‚Äª„Åì„ÅÆÊìç‰Ωú„ÅØÂèñ„ÇäÊ∂à„Åõ„Åæ„Åõ„Çì`;
                
                if (!confirm(confirmMessage)) {
                    return;
                }
                
                // ÂâäÈô§ÂÆüË°å
                const updatedRecords = workRecords.filter(r => r.timestamp !== timestamp);
                Storage.set('workRecords', updatedRecords);
                
                console.log('‰ΩúÊ•≠Ë®òÈå≤„ÇíÂâäÈô§„Åó„Åæ„Åó„Åü:', record);
                
                // „É¨„Éù„Éº„ÉàÂÜçË°®Á§∫
                const activeTab = document.querySelector('.report-tab.active');
                const period = activeTab ? activeTab.dataset.period : 'daily';
                updateReport(period);
                
                alert('‚úÖ ‰ΩúÊ•≠Ë®òÈå≤„ÇíÂâäÈô§„Åó„Åæ„Åó„Åü');
            } catch (error) {
                console.error('ÂâäÈô§„Ç®„É©„Éº:', error);
                alert('‚ùå ÂâäÈô§„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message);
            }
        };

        // „É¨„Éù„Éº„ÉàÊúüÈñì„Çø„Éñ
        document.querySelectorAll('.report-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.report-tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                updateReport(tab.dataset.period);
            });
        });

        // PDFÂá∫Âäõ
        document.getElementById('exportReportBtn').addEventListener('click', () => {
            window.print();
        });
        
        // „É¨„Éù„Éº„Éà„Éá„Éº„Çø„Ç®„ÇØ„Çπ„Éù„Éº„Éà
        document.getElementById('exportReportDataBtn').addEventListener('click', () => {
            try {
                const activeTab = document.querySelector('.report-tab.active');
                const period = activeTab ? activeTab.dataset.period : 'daily';
                
                const workRecords = Storage.getArray('workRecords');
                const locations = Storage.getArray('locations');
                
                if (workRecords.length === 0) {
                    alert('„Ç®„ÇØ„Çπ„Éù„Éº„Éà„Åô„Çã‰ΩúÊ•≠Ë®òÈå≤„Åå„ÅÇ„Çä„Åæ„Åõ„Çì');
                    return;
                }
                
                let filteredRecords = workRecords;
                const now = new Date();
                
                if (period === 'weekly') {
                    const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                    filteredRecords = workRecords.filter(r => new Date(r.date) >= weekAgo);
                } else if (period === 'monthly') {
                    const monthAgo = new Date(now.getFullYear(), now.getMonth() - 1, now.getDate());
                    filteredRecords = workRecords.filter(r => new Date(r.date) >= monthAgo);
                }
                
                // ÈõÜË®à„Éá„Éº„Çø„ÇíÁîüÊàê
                const summary = {};
                filteredRecords.forEach(record => {
                    record.locations.forEach(loc => {
                        if (!summary[loc.locationId]) {
                            const locationInfo = locations.find(l => l.id === loc.locationId) || {};
                            summary[loc.locationId] = {
                                name: loc.name,
                                count: 0,
                                totalTime: 0,
                                totalRevenue: 0,
                                dayMinutes: 0,
                                nightMinutes: 0,
                                workDetails: []
                            };
                        }
                        summary[loc.locationId].count++;
                        
                        if (loc.netWorkTime !== undefined) {
                            summary[loc.locationId].totalTime += loc.netWorkTime;
                        } else {
                            const workTime = calculateTimeDiff(loc.workStart, loc.workEnd);
                            const breakTime = calculateTimeDiff(loc.breakStart, loc.breakEnd);
                            summary[loc.locationId].totalTime += (workTime - breakTime);
                        }
                        
                        // ÊòºÂ§ú„ÅÆÊôÇÈñì„ÇíÈõÜË®à
                        if (loc.dayMinutes !== undefined && loc.nightMinutes !== undefined) {
                            summary[loc.locationId].dayMinutes += loc.dayMinutes;
                            summary[loc.locationId].nightMinutes += loc.nightMinutes;
                        }
                        
                        if (loc.calculatedAmount !== undefined) {
                            summary[loc.locationId].totalRevenue += loc.calculatedAmount;
                        }
                        
                        summary[loc.locationId].workDetails.push({
                            date: record.date,
                            workStart: loc.workStart,
                            workEnd: loc.workEnd,
                            breakStart: loc.breakStart,
                            breakEnd: loc.breakEnd,
                            netWorkTime: loc.netWorkTime,
                            dayMinutes: loc.dayMinutes || 0,
                            nightMinutes: loc.nightMinutes || 0,
                            calculatedAmount: loc.calculatedAmount || 0
                        });
                    });
                });
                
                const summaryArray = Object.values(summary).map(s => ({
                    ...s,
                    avgTime: s.totalTime / s.count
                }));
                
                const totalRevenue = summaryArray.reduce((sum, s) => sum + s.totalRevenue, 0);
                const totalWorkTime = summaryArray.reduce((sum, s) => sum + s.totalTime, 0);
                const totalDayMinutes = summaryArray.reduce((sum, s) => sum + s.dayMinutes, 0);
                const totalNightMinutes = summaryArray.reduce((sum, s) => sum + s.nightMinutes, 0);
                
                // PDFÁîüÊàê
                generateReportPDF(period, summaryArray, {
                    totalRevenue,
                    totalWorkTime,
                    totalDayMinutes,
                    totalNightMinutes
                });
                
            } catch (error) {
                console.error('Report export error:', error);
                alert('‚ùå „É¨„Éù„Éº„Éà„ÅÆ„Ç®„ÇØ„Çπ„Éù„Éº„Éà„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message);
            }
        });
        
        // PDFÁîüÊàêÈñ¢Êï∞
        function generateReportPDF(period, summaryArray, totals) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({
                orientation: 'landscape', // A4Ê®™
                unit: 'mm',
                format: 'a4'
            });
            
            const periodName = period === 'daily' ? 'Êó•Ê¨°' : period === 'weekly' ? 'ÈÄ±Ê¨°' : 'ÊúàÊ¨°';
            const dateStr = new Date().toLocaleDateString('ja-JP', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit'
            });
            
            // „Çø„Ç§„Éà„É´
            doc.setFontSize(18);
            doc.text('Èô§Èõ™‰ΩúÊ•≠ ÈõÜË®àË°®', 148, 15, { align: 'center' });
            
            doc.setFontSize(12);
            doc.text(`${periodName}„É¨„Éù„Éº„Éà`, 148, 23, { align: 'center' });
            doc.text(`Âá∫ÂäõÊó•: ${dateStr}`, 148, 30, { align: 'center' });
            
            // Ë°®„ÅÆ„Éò„ÉÉ„ÉÄ„Éº„Å®„Éá„Éº„Çø
            const headers = [
                ['Â•ëÁ¥ÑÂÖàÂêç', '‰ΩúÊ•≠ÂõûÊï∞', 'ÊòºÈñìÊôÇÈñì\n(ÂàÜ)', 'Â§úÈñìÊôÇÈñì\n(ÂàÜ)', 'ÂêàË®àÊôÇÈñì\n(ÂàÜ)', 'Â£≤‰∏äÈáëÈ°ç\n(ÂÜÜ)']
            ];
            
            const data = summaryArray.map(item => [
                item.name,
                item.count + 'Âõû',
                item.dayMinutes || '-',
                item.nightMinutes || '-',
                item.totalTime,
                '¬•' + item.totalRevenue.toLocaleString()
            ]);
            
            // ÂêàË®àË°å
            data.push([
                'ÂêàË®à',
                summaryArray.reduce((sum, s) => sum + s.count, 0) + 'Âõû',
                totals.totalDayMinutes || '-',
                totals.totalNightMinutes || '-',
                totals.totalWorkTime,
                '¬•' + totals.totalRevenue.toLocaleString()
            ]);
            
            // Ë°®„ÇíÁîüÊàê
            doc.autoTable({
                startY: 40,
                head: headers,
                body: data,
                theme: 'grid',
                styles: {
                    font: 'helvetica',
                    fontSize: 11,
                    cellPadding: 4,
                    overflow: 'linebreak',
                    halign: 'center',
                    valign: 'middle'
                },
                headStyles: {
                    fillColor: [0, 212, 255],
                    textColor: [255, 255, 255],
                    fontStyle: 'bold',
                    fontSize: 12
                },
                columnStyles: {
                    0: { halign: 'left', cellWidth: 60 },  // Â•ëÁ¥ÑÂÖàÂêç
                    1: { halign: 'center', cellWidth: 30 }, // ‰ΩúÊ•≠ÂõûÊï∞
                    2: { halign: 'right', cellWidth: 30 },  // ÊòºÈñìÊôÇÈñì
                    3: { halign: 'right', cellWidth: 30 },  // Â§úÈñìÊôÇÈñì
                    4: { halign: 'right', cellWidth: 30 },  // ÂêàË®àÊôÇÈñì
                    5: { halign: 'right', cellWidth: 50 }   // Â£≤‰∏äÈáëÈ°ç
                },
                didParseCell: function(data) {
                    // ÂêàË®àË°å„ÇíÂ§™Â≠ó„Å´
                    if (data.row.index === summaryArray.length) {
                        data.cell.styles.fontStyle = 'bold';
                        data.cell.styles.fillColor = [240, 240, 240];
                    }
                }
            });
            
            // „Éï„ÉÉ„Çø„Éº
            const pageCount = doc.internal.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
                doc.setPage(i);
                doc.setFontSize(9);
                doc.text(
                    `SNOW OPS - Èô§Èõ™Âá∫Êù•È´òÁÆ°ÁêÜ„Ç∑„Çπ„ÉÜ„É†   „Éö„Éº„Ç∏ ${i} / ${pageCount}`,
                    148,
                    200,
                    { align: 'center' }
                );
            }
            
            // ‰øùÂ≠ò
            doc.save(`Èô§Èõ™ÈõÜË®àË°®_${periodName}_${dateStr.replace(/\//g, '')}.pdf`);
            
            alert(`‚úÖ ${periodName}„É¨„Éù„Éº„Éà„ÇíPDFÂá∫Âäõ„Åó„Åæ„Åó„ÅüÔºÅ\n\nÁ∑èÂ£≤‰∏ä: ¬•${totals.totalRevenue.toLocaleString()}\nÁ∑è‰ΩúÊ•≠ÊôÇÈñì: ${totals.totalWorkTime}ÂàÜ`);
        }

        // ÂàùÊúüÂåñ
        updateCurrentDate();
        renderLocationList();
        setInterval(updateCurrentDate, 60000);
        
        // „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº„ÅåÊ≠£„Åó„ÅèÁôªÈå≤„Åï„Çå„Åü„ÅãÁ¢∫Ë™ç
        console.log('„Ç¢„Éó„É™ÂàùÊúüÂåñÂÆå‰∫Ü');
        console.log('saveWorkBtn:', document.getElementById('saveWorkBtn'));
        
        // ÂÖ•ÂäõÊ¨Ñ„Åß„Ç≥„Éî„Éº&„Éö„Éº„Çπ„Éà„ÇíÊòéÁ§∫ÁöÑ„Å´Ë®±ÂèØ
        document.querySelectorAll('.form-input').forEach(input => {
            // „Ç≥„Éî„Éº&„Éö„Éº„Çπ„Éà„Ç§„Éô„É≥„Éà„ÅÆ‰ºùÊí≠„ÇíË®±ÂèØ
            input.addEventListener('copy', (e) => {
                e.stopPropagation();
            }, true);
            
            input.addEventListener('cut', (e) => {
                e.stopPropagation();
            }, true);
            
            input.addEventListener('paste', (e) => {
                e.stopPropagation();
            }, true);
            
            // „Çø„ÉÉ„ÉÅ„Ç§„Éô„É≥„Éà„ÅÆ‰ºùÊí≠„ÇÇË®±ÂèØ
            input.addEventListener('touchstart', (e) => {
                e.stopPropagation();
            }, true);
            
            input.addEventListener('touchmove', (e) => {
                e.stopPropagation();
            }, true);
            
            input.addEventListener('touchend', (e) => {
                e.stopPropagation();
            }, true);
        });
        
        // PWA „Ç§„É≥„Çπ„Éà„Éº„É´Âá¶ÁêÜ
        let deferredPrompt;
        
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            
            // „Ç§„É≥„Çπ„Éà„Éº„É´„Éú„Çø„É≥„ÇíË°®Á§∫Ôºà„Éò„ÉÉ„ÉÄ„Éº„Å´ËøΩÂä†Ôºâ
            const installBtn = document.createElement('button');
            installBtn.textContent = 'üì± „Ç¢„Éó„É™Âåñ';
            installBtn.className = 'btn btn-secondary btn-small';
            installBtn.style.cssText = 'position: fixed; top: 1rem; right: 1rem; z-index: 1000; width: auto; padding: 0.5rem 1rem; font-size: 0.75rem; margin: 0;';
            
            installBtn.addEventListener('click', async () => {
                if (deferredPrompt) {
                    deferredPrompt.prompt();
                    const { outcome } = await deferredPrompt.userChoice;
                    console.log(`User response: ${outcome}`);
                    deferredPrompt = null;
                    installBtn.remove();
                }
            });
            
            document.body.appendChild(installBtn);
            
            // 3ÁßíÂæå„Å´„Éï„Çß„Éº„Éâ„Ç§„É≥
            setTimeout(() => {
                installBtn.style.opacity = '0';
                installBtn.style.transition = 'opacity 0.5s';
                setTimeout(() => installBtn.style.opacity = '1', 100);
            }, 3000);
        });
        
        // „Ç§„É≥„Çπ„Éà„Éº„É´ÂÆå‰∫Ü„Ç§„Éô„É≥„Éà
        window.addEventListener('appinstalled', () => {
            console.log('PWA installed successfully');
            deferredPrompt = null;
        });
        
        // Service WorkerÁôªÈå≤
        if ('serviceWorker' in navigator) {
            // Service Worker„Çí„Ç§„É≥„É©„Ç§„É≥„ÅßÁôªÈå≤
            const swCode = `
                const CACHE_NAME = 'snow-ops-v1';
                const urlsToCache = ['./', 'https://fonts.googleapis.com', 'https://fonts.gstatic.com'];
                
                self.addEventListener('install', (event) => {
                    event.waitUntil(
                        caches.open(CACHE_NAME).then((cache) => cache.addAll(urlsToCache))
                    );
                });
                
                self.addEventListener('fetch', (event) => {
                    event.respondWith(
                        caches.match(event.request).then((response) => {
                            return response || fetch(event.request);
                        })
                    );
                });
            `;
            
            const blob = new Blob([swCode], { type: 'application/javascript' });
            const swUrl = URL.createObjectURL(blob);
            
            navigator.serviceWorker.register(swUrl)
                .then(registration => {
                    console.log('Service Worker registered:', registration);
                })
                .catch(error => {
                    console.log('Service Worker registration failed:', error);
                });
        }
        
        // „Éë„Éï„Ç©„Éº„Éû„É≥„ÇπÊúÄÈÅ©Âåñ: passive event listeners
        document.addEventListener('touchstart', () => {}, { passive: true });
        document.addEventListener('touchmove', () => {}, { passive: true });
        
        // „Çπ„Éû„Éõ„ÅÆ„Çπ„ÇØ„É≠„Éº„É´ÊúÄÈÅ©Âåñ
        if ('scrollRestoration' in history) {
            history.scrollRestoration = 'manual';
        }
        
        // „Éê„ÉÉ„ÇØ„Ç∞„É©„Ç¶„É≥„ÉâÊôÇ„ÅÆ„Çø„Ç§„Éû„ÉºÂÅúÊ≠¢
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                // „Ç¢„Éó„É™„Åå„Éê„ÉÉ„ÇØ„Ç∞„É©„Ç¶„É≥„Éâ„Å´
                console.log('App in background');
            } else {
                // „Ç¢„Éó„É™„Åå„Éï„Ç©„Ç¢„Ç∞„É©„Ç¶„É≥„Éâ„Å´
                console.log('App in foreground');
                updateCurrentDate();
            }
        });
        
        // ÂÆöÊúüÁöÑ„Å™Ëá™Âãï‰øùÂ≠òÔºà30Áßí„Åî„Å®Ôºâ
        setInterval(() => {
            if (workItems.length > 0) {
                saveWorkInProgress();
            }
        }, 30000);
        
        // „Éö„Éº„Ç∏„ÇíÈõ¢„Çå„ÇãÂâç„ÅÆÁ¢∫Ë™ç
        window.addEventListener('beforeunload', (e) => {
            // ‰ΩúÊ•≠‰∏≠„Éá„Éº„Çø„Çí‰øùÂ≠ò
            if (workItems.length > 0) {
                saveWorkInProgress();
                
                // Êú™‰øùÂ≠ò„ÅÆ‰ΩúÊ•≠„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅØË≠¶Âëä
                const hasUnsavedWork = workItems.some(item => {
                    const workEnd = document.querySelector(`.work-end[data-id="${item.id}"]`);
                    return workEnd && workEnd.value; // ÁµÇ‰∫ÜÊôÇÈñì„ÅåÂÖ•Âäõ„Åï„Çå„Å¶„ÅÑ„Çã
                });
                
                if (hasUnsavedWork) {
                    e.preventDefault();
                    e.returnValue = 'Êú™‰øùÂ≠ò„ÅÆ‰ΩúÊ•≠„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇÊú¨ÂΩì„Å´„Éö„Éº„Ç∏„ÇíÈõ¢„Çå„Åæ„Åô„ÅãÔºü';
                    return e.returnValue;
                }
            }
        });
        
        // ÂàùÊúüÂåñ
        updateCurrentDate();
        renderLocationList();
        updateReport('daily');
        
        }); // DOMContentLoadedÁµÇ‰∫Ü
    </script>
</body>
</html>
